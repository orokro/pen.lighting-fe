import{_ as G,r as f,p as c,w as K,o as W,a as I,c as y,b as d,l as A,y as w,g as Q,m as U,F as D,x as Z,d as C,s as P,k as ee,z as te,f as oe,u as se}from"./index-RybedRza.js";import{u as ne}from"./useRoomDetails-D3wD6UGB.js";const ae=["aria-label"],re=["src"],ie={class:"pen__name"},le={__name:"OBSRoom",props:{roomDetails:{type:Object,required:!0},users:{type:Array,required:!0}},setup(g){const o=g,i=f(null),l=f(1),h=f(1);function k(){const e=i.value;if(!e)return;const t=e.getBoundingClientRect();l.value=Math.max(1,t.width),h.value=Math.max(1,t.height)}const $=c(()=>Math.min(256,Math.floor(h.value/4))),N=c(()=>{const e=o.roomDetails?.penlightSprite;return e?`data:image/png;base64,${e}`:"/img/default_light.png"});function b(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(t=>t+t).join("")),e.length===6)?e:null)}const F=c(()=>b(o.roomDetails?.themeColor)||"FFFFFF"),E=c(()=>Array.isArray(o.roomDetails?.penColors)&&o.roomDetails.penColors.length>0),_=c(()=>(o.roomDetails?.penColors||[]).map(b).filter(Boolean));function T(e){const t=b(e?.color);if(t)return t;if(E.value&&_.value.length>0){const n=_.value.length,s=Number.parseInt(e?.color,10);return Number.isFinite(s)?_.value[(s%n+n)%n]:_.value[0]}return F.value}const z=c(()=>o.roomDetails?.showCode||"hidden"),H=c(()=>{switch(z.value){case"top-left":return"code-top-left";case"top-right":return"code-top-right";case"bottom-left":return"code-bottom-left";case"bottom-right":return"code-bottom-right";default:return"code-hidden"}}),V=c(()=>({"--code-color":`#${F.value}`}));function j(e){const t=[],n=!!o.roomDetails?.duplicateUsers,s=Number(o.roomDetails?.duplicationThreshold||0),a=e.length;if(!n||s<=0||a>=s){for(let r=0;r<a;r++){const u=e[r];t.push({...u,opacity:1,key:`u-${r}`})}return t}const m=Math.max(0,s-a),M=Math.min(3,Math.max(1,Math.ceil(m/Math.max(1,a))));for(let r=0;r<a;r++){const u=e[r];t.push({...u,opacity:1,key:`u-${r}`});for(let p=0;p<M;p++){const L=q(r,p);t.push({...u,x:v(u.x+L.dx),y:v(u.y+L.dy),opacity:.8,key:`u-${r}-d${p}`})}}return t}function q(e,t){const n=[0,72,144,216,288],s=n[(e+t)%n.length]*Math.PI/180,a=.18+(e+t)%3*.05;return{dx:a*Math.cos(s),dy:a*Math.sin(s)}}function v(e){return Math.max(0,Math.min(1,e))}const S=f([]);let x=null;function B(e){const t=o.users.length,n=Array.from({length:t},(s,a)=>a);for(let s=t-1;s>0;s--){const a=Math.floor(Math.random()*(s+1));[n[s],n[a]]=[n[a],n[s]]}S.value=n.slice(0,e)}function O(){const e=Number(o.roomDetails?.maxConcurrent||0);if(!e||o.users.length<=e){S.value=[],R();return}B(e),R(),x=setInterval(()=>B(e),1e3)}function R(){x&&(clearInterval(x),x=null)}K(()=>[o.users.length,o.roomDetails?.maxConcurrent],()=>O(),{immediate:!0});const J=c(()=>{const e=Number(o.roomDetails?.maxConcurrent||0);let t=o.users;if(e&&t.length>e){const s=new Set(S.value);t=t.filter((a,m)=>s.has(m))}return j(t.map((s,a)=>{const m=v(Number(s.x)),M=v(Number(s.y)),r=Number(s.theta||0),u=T(s),p=String(s.nickname||"");return{x:m,y:M,theta:r,hex:u,nickname:p,opacity:1,key:`b-${a}`}}))});function X(e){const t=$.value,n=e.x*l.value,s=e.y*h.value,a=n-t/2,m=s-t/2;return{width:`${t}px`,height:`${t}px`,transform:`translate(${a}px, ${m}px) rotate(${e.theta}deg)`,opacity:e.opacity,"--beam-color":`#${e.hex}`}}function Y(e){const t=`url("${N.value}")`;return{background:`#${e}`,maskImage:t,maskRepeat:"no-repeat",maskSize:"100% 250%",maskPosition:"top left",WebkitMaskImage:t,WebkitMaskRepeat:"no-repeat",WebkitMaskSize:"100% 250%",WebkitMaskPosition:"top left",opacity:.5}}return W(()=>{k();const e=new ResizeObserver(k);e.observe(i.value),i.value.__ro=e,O()}),I(()=>{R();const e=i.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,t)=>(d(),y("div",{ref_key:"stageRef",ref:i,class:"obs-stage"},[z.value!=="hidden"?(d(),y("div",{key:0,class:Q(["room-code",H.value]),style:w(V.value)},U(g.roomDetails.code),7)):A("",!0),(d(!0),y(D,null,Z(J.value,n=>(d(),y("div",{key:n.key,class:"pen",style:w(X(n)),"aria-label":n.nickname||"penlight",role:"img"},[C("img",{class:"pen__img",src:N.value,alt:"",draggable:"false"},null,8,re),C("div",{class:"pen__tint",style:w(Y(n.hex))},null,4),C("div",ie,U(n.nickname),1)],12,ae))),128))],512))}},ce=G(le,[["__scopeId","data-v-396b1a35"]]);class ue{constructor(o,i){this.roomCode=o,this.wsUrl=i??this._deriveWSUrl(),this._users=[],this.usersListRef=P([]),this.connectionStatusRef=f("idle"),this._socket=null,this._closedManually=!1,this.connect()}_deriveWSUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//api.${window.location.host}`}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const o=new WebSocket(this.wsUrl);this._socket=o,o.addEventListener("open",()=>{this.connectionStatusRef.value="open",o.send(JSON.stringify({type:"hello",role:"obs",roomCode:this.roomCode}))}),o.addEventListener("message",i=>{let l;try{l=JSON.parse(i.data)}catch{return}l?.type==="state"&&l?.room===this.roomCode&&Array.isArray(l.users)&&(this._users=l.users,this.usersListRef.value=[...this._users])}),o.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),o.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{o.close()}catch{}})}destroy(){if(this._closedManually=!0,this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this._users=[],this.usersListRef.value=[],this.connectionStatusRef.value="closed"}}const he="wss://api.pen.lighting/ws",pe={__name:"ObsView",props:{room_code:String},setup(g){const o=P(null),i=ee();se();const l=i.params.room_code,h=f(null);return W(async()=>{o.value=new ue(l,he),h.value=await ne()}),I(()=>{o.value&&(o.value.destroy(),o.value=null)}),(k,$)=>(d(),y(D,null,[o.value==null||h.value==null?(d(),y(D,{key:0},[oe(" Connecting... ")],64)):(d(),te(ce,{key:1,roomDetails:h.value,users:o.value.usersListRef.value},null,8,["roomDetails","users"])),A("",!0)],64))}};export{pe as default};
