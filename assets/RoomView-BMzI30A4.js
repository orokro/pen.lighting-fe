import{_ as X,r as l,p as C,c as y,b as v,d as h,l as F,y as P,F as I,x as oe,o as $,a as z,A as f,j as L,f as A,m as se,w as ne,u as ae,s as B,h as le,z as re}from"./index-BtlqQoGs.js";import{P as ue,u as ie}from"./useRoomDetails-COREN6ba.js";import{u as ce}from"./useRoomSession-k9OBCSQl.js";const me={class:"color-select-list"},de={key:0,class:"color-menu"},fe=["onClick"],he={__name:"ColorSelectList",props:{colors:{type:Array,required:!0},modelValue:{type:Number,required:!0}},emits:["change","update:modelValue"],setup(i,{emit:o}){const s=i,r=o,a=l(!1),d=C(()=>"#"+s.colors[s.modelValue]);function p(n){const _=parseInt(n.substr(1,2),16),R=parseInt(n.substr(3,2),16),g=parseInt(n.substr(5,2),16);return(_*299+R*587+g*114)/1e3>=128?"#000000":"#FFFFFF"}const k=C(()=>p(d.value));function c(){a.value=!a.value}function T(n){r("update:modelValue",n),r("change",n),a.value=!1}function x(n){n.target.closest(".color-select-list")||(a.value=!1)}return document.addEventListener("click",x),(n,_)=>(v(),y("div",me,[h("button",{class:"color-button",style:P({backgroundColor:d.value,color:k.value}),onClick:c}," Pick Color! ",4),a.value?(v(),y("div",de,[(v(!0),y(I,null,oe(i.colors,(R,g)=>(v(),y("div",{key:R,class:"color-swatch",style:P({backgroundColor:"#"+R}),onClick:b=>T(g)},null,12,fe))),128))])):F("",!0)]))}},ve=X(he,[["__scopeId","data-v-e660ffa4"]]),pe={class:"checkbox"},Re=["checked"],ye={class:"hint"},ge={key:0},Se={class:"pen-container"},ke={__name:"PenRoom",props:{roomDetails:{type:Object,required:!0},userRoomState:{type:Object,required:!0}},setup(i){const o=i,s=l(null),r=l(1),a=l(1),d=l(null);function p(){const e=s.value;if(!e)return;const t=e.getBoundingClientRect();r.value=Math.max(1,t.width),a.value=Math.max(1,t.height)}const k=C(()=>c.value?o.roomDetails.penColors[o.userRoomState?.colorRef?.value]:T(o.roomDetails?.themeColor)||"FFFFFF"),c=C(()=>{const e=o.roomDetails?.penColors;return Array.isArray(e)&&e.length>0});function T(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(t=>t+t).join("")),e.length===6)?e:null)}const x=C(()=>({x:(o.userRoomState.xRef.value??.5)*r.value,y:(o.userRoomState.yRef.value??.5)*a.value,theta:o.userRoomState.thetaRef.value}));function n(e,t,u){return Math.max(t,Math.min(u,e))}function _(e,t,u){return e+(t-e)*u}const R=l(.5),g=l(.5),b=l(0);let N=0,D=null,q=0;function M(e){const t=e/1e3;N===0&&(N=t);const u=Math.max(.001,t-N),m=n(R.value+b.value,0,1),S=D==null?0:(m-D)/u,U=(S-q)/u;let Q=n(U*18,-90,90);const Z=Number(o.userRoomState.thetaRef.value||0),ee=n(u*6,0,.65),te=_(Z,Q,ee);o.userRoomState.thetaRef.value=te,o.userRoomState.xRef.value=m,o.userRoomState.yRef.value=n(g.value,0,1),N=t,D=m,q=S}function W(e,t){const m=s.value.getBoundingClientRect(),S=n((e-m.left)/m.width,0,1),U=n((t-m.top)/m.height,0,1);R.value=S,g.value=U,M(performance.now())}function Y(e){W(e.clientX,e.clientY)}function j(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&W(t.clientX,t.clientY)}function H(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&W(t.clientX,t.clientY)}function J(){}const V=l(!1);let w=null,E=0;function G(e){!!e.target.checked?K():O()}function K(){O(),V.value=!0,E=performance.now();const e=140/60,t=.1,u=m=>{const S=(m-E)/1e3;b.value=t*Math.sin(2*Math.PI*e*S),M(m),w=requestAnimationFrame(u)};w=requestAnimationFrame(u)}function O(){w!=null&&(cancelAnimationFrame(w),w=null),b.value=0,V.value=!1,M(performance.now())}return $(()=>{p();const e=new ResizeObserver(p);e.observe(s.value),s.value.__ro=e,Number.isFinite(o.userRoomState.xRef.value)||(o.userRoomState.xRef.value=.5),Number.isFinite(o.userRoomState.yRef.value)||(o.userRoomState.yRef.value=.5),Number.isFinite(o.userRoomState.thetaRef.value)||(o.userRoomState.thetaRef.value=0),R.value=n(Number(o.userRoomState.xRef.value),0,1),g.value=n(Number(o.userRoomState.yRef.value),0,1),M(performance.now())}),z(()=>{O();const e=s.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,t)=>(v(),y("div",{ref_key:"stageRef",ref:s,class:"room-stage",onMousemove:Y,onTouchstart:j,onTouchmove:H,onTouchend:J,onContextmenu:t[9]||(t[9]=f(()=>{},["prevent"]))},[c.value?(v(),y("div",{key:0,class:"ui ui-left",onTouchstart:t[1]||(t[1]=f(()=>{},["stop"])),onTouchmove:t[2]||(t[2]=f(()=>{},["stop"])),onTouchend:t[3]||(t[3]=f(()=>{},["stop"])),onClick:t[4]||(t[4]=f(()=>{},["stop"]))},[L(ve,{colors:i.roomDetails.penColors,modelValue:o.userRoomState.colorRef.value,"onUpdate:modelValue":t[0]||(t[0]=u=>o.userRoomState.colorRef.value=u)},null,8,["colors","modelValue"])],32)):F("",!0),h("div",{class:"ui ui-right",onTouchstart:t[5]||(t[5]=f(()=>{},["stop"])),onTouchmove:t[6]||(t[6]=f(()=>{},["stop"])),onTouchend:t[7]||(t[7]=f(()=>{},["stop"])),onClick:t[8]||(t[8]=f(()=>{},["stop"]))},[h("label",pe,[h("input",{type:"checkbox",checked:V.value,onChange:G},null,40,Re),t[10]||(t[10]=h("span",null,"Auto Wave",-1))])],32),h("div",ye,[i.roomDetails.name!=""&&i.roomDetails.name!=null?(v(),y("div",ge,[A(' Welcome to "'+se(i.roomDetails.name)+'" Penlight Audience! ',1),t[11]||(t[11]=h("br",null,null,-1)),t[12]||(t[12]=h("br",null,null,-1))])):F("",!0),t[13]||(t[13]=A(" Drag your finger/mouse around! ",-1))]),F("",!0),h("div",Se,[L(ue,{ref_key:"penRef",ref:d,roomDetails:i.roomDetails,color:k.value,opacity:1,penTransform:x.value,nickName:o.userRoomState.nickname||"Guest"},null,8,["roomDetails","color","penTransform","nickName"])])],544))}},_e=X(ke,[["__scopeId","data-v-efcc3dca"]]),be="wss://api.pen.lighting/ws";class we{constructor(o,s,r,a,d=0){this.roomCode=o,this.nickname=s||"guest",this.password=r,this.wsUrl=a??this._deriveWSUrl(),this.xRef=l(-100),this.yRef=l(-100),this.thetaRef=l(0),this.colorRef=l(0),this.connectionStatusRef=l("idle"),this._socket=null,this._closedManually=!1,this._sendTimer=null,this._debounceMs=Math.max(0,d|5),this.connect(),this._wireWatches()}_deriveWSUrl(){return be}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const o=new WebSocket(this.wsUrl);this._socket=o,o.addEventListener("open",()=>{this.connectionStatusRef.value="open";const s={type:"hello",role:"user",roomCode:this.roomCode,nickname:this.nickname};this.password!==void 0&&(s.password=this.password),o.send(JSON.stringify(s)),this._scheduleSend()}),o.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),o.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{o.close()}catch{}}),o.addEventListener("message",s=>{let r;try{r=JSON.parse(s.data)}catch{return}if(r?.type==="roomSettings"){const a=r.settings;console.log("New Settings",a),window.location.reload()}})}_wireWatches(){[this.xRef,this.yRef,this.thetaRef,this.colorRef].forEach(o=>{ne(o,()=>this._scheduleSend(),{flush:"post"})})}_scheduleSend(){!this._socket||this._socket.readyState!==WebSocket.OPEN||this._sendTimer||(this._sendTimer=setTimeout(()=>{this._sendTimer=null,this._sendUpdate()},this._debounceMs))}_sendUpdate(){if(!this._socket||this._socket.readyState!==WebSocket.OPEN)return;const o={type:"update",x:Number(this.xRef.value),y:Number(this.yRef.value),theta:Number(this.thetaRef.value),color:Number(this.colorRef.value)};try{this._socket.send(JSON.stringify(o))}catch{}}destroy(){if(this._closedManually=!0,this._sendTimer&&(clearTimeout(this._sendTimer),this._sendTimer=null),this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this.connectionStatusRef.value="closed"}}const Me={__name:"RoomView",props:{room_code:String},setup(i){const{getRoomSession:o}=ce(),s=ae(),r=le(),a=s.params.room_code,d=B(o(a)),p=l(null),k="wss://api.pen.lighting/ws",c=B(null);return $(async()=>{if(!d.value){r.push({name:"home",query:{room_code:a}});return}c.value=new we(a,d.value.username,d.value.roomPwd,k),p.value=await ie()}),z(()=>{c.value&&(c.value.destroy(),c.value=null)}),(T,x)=>c.value==null||p.value==null?(v(),y(I,{key:0},[A(" Connecting... ")],64)):(v(),re(_e,{key:1,roomDetails:p.value,userRoomState:c.value},null,8,["roomDetails","userRoomState"]))}};export{Me as default};
