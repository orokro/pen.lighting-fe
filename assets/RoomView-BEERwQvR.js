import{_ as oe,r as a,p as F,o as q,a as L,c as S,b as v,l as U,d as c,A as m,F as V,x as se,f as A,m as B,j as ne,w as ae,u as re,s as X,h as le,z as ie}from"./index-CV9c4C8w.js";import{P as ue,u as ce}from"./useRoomDetails-DQnv8edM.js";import{u as me}from"./useRoomSession-k9OBCSQl.js";const fe=["value","selected"],he={class:"checkbox"},de=["checked"],ve={class:"hint"},pe={key:0},Re={class:"pen-container"},Se={__name:"PenRoom",props:{roomDetails:{type:Object,required:!0},userRoomState:{type:Object,required:!0}},setup(f){const o=f,s=a(null),l=a(1),i=a(1),d=a(null);function p(){const e=s.value;if(!e)return;const t=e.getBoundingClientRect();l.value=Math.max(1,t.width),i.value=Math.max(1,t.height)}const y=F(()=>u.value?o.roomDetails.penColors[o.userRoomState?.colorRef?.value]:w(o.roomDetails?.themeColor)||"FFFFFF"),u=F(()=>{const e=o.roomDetails?.penColors;return Array.isArray(e)&&e.length>0});function w(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(t=>t+t).join("")),e.length===6)?e:null)}function O(e){return y.value===w(e)}function Y(e){const t=String(e.target.value||"").replace(/^#/,"");o.userRoomState.colorRef.value=t}const j=F(()=>({x:(o.userRoomState.xRef.value??.5)*l.value,y:(o.userRoomState.yRef.value??.5)*i.value,theta:o.userRoomState.thetaRef.value}));function h(e,t,n){return Math.max(t,Math.min(n,e))}function z(e,t,n){return e+(t-e)*n}const b=a(.5),T=a(.5),x=a(0);let k=0,C=null,E=0;function _(e){const t=e/1e3;k===0&&(k=t);const n=Math.max(.001,t-k),r=h(b.value+x.value,0,1),R=C==null?0:(r-C)/n,W=(R-E)/n;let Q=h(W*18,-90,90);const Z=Number(o.userRoomState.thetaRef.value||0),ee=h(n*6,0,.65),te=z(Z,Q,ee);o.userRoomState.thetaRef.value=te,o.userRoomState.xRef.value=r,o.userRoomState.yRef.value=h(T.value,0,1),k=t,C=r,E=R}function N(e,t){const r=s.value.getBoundingClientRect(),R=h((e-r.left)/r.width,0,1),W=h((t-r.top)/r.height,0,1);b.value=R,T.value=W,_(performance.now())}function H(e){N(e.clientX,e.clientY)}function I(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&N(t.clientX,t.clientY)}function J(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&N(t.clientX,t.clientY)}function G(){}const M=a(!1);let g=null,P=0;function K(e){!!e.target.checked?$():D()}function $(){D(),M.value=!0,P=performance.now();const e=140/60,t=.1,n=r=>{const R=(r-P)/1e3;x.value=t*Math.sin(2*Math.PI*e*R),_(r),g=requestAnimationFrame(n)};g=requestAnimationFrame(n)}function D(){g!=null&&(cancelAnimationFrame(g),g=null),x.value=0,M.value=!1,_(performance.now())}return q(()=>{p();const e=new ResizeObserver(p);e.observe(s.value),s.value.__ro=e,Number.isFinite(o.userRoomState.xRef.value)||(o.userRoomState.xRef.value=.5),Number.isFinite(o.userRoomState.yRef.value)||(o.userRoomState.yRef.value=.5),Number.isFinite(o.userRoomState.thetaRef.value)||(o.userRoomState.thetaRef.value=0),b.value=h(Number(o.userRoomState.xRef.value),0,1),T.value=h(Number(o.userRoomState.yRef.value),0,1),_(performance.now())}),L(()=>{D();const e=s.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,t)=>(v(),S("div",{ref_key:"stageRef",ref:s,class:"room-stage",onMousemove:H,onTouchstart:I,onTouchmove:J,onTouchend:G,onContextmenu:t[8]||(t[8]=m(()=>{},["prevent"]))},[u.value?(v(),S("div",{key:0,class:"ui ui-left",onTouchstart:t[0]||(t[0]=m(()=>{},["stop"])),onTouchmove:t[1]||(t[1]=m(()=>{},["stop"])),onTouchend:t[2]||(t[2]=m(()=>{},["stop"])),onClick:t[3]||(t[3]=m(()=>{},["stop"]))},[c("select",{id:"colorSelect",class:"color-select",onChange:Y},[(v(!0),S(V,null,se(f.roomDetails.penColors,(n,r)=>(v(),S("option",{key:n,value:r,selected:O(n)},B("#"+n.toUpperCase()),9,fe))),128))],32)],32)):U("",!0),c("div",{class:"ui ui-right",onTouchstart:t[4]||(t[4]=m(()=>{},["stop"])),onTouchmove:t[5]||(t[5]=m(()=>{},["stop"])),onTouchend:t[6]||(t[6]=m(()=>{},["stop"])),onClick:t[7]||(t[7]=m(()=>{},["stop"]))},[c("label",he,[c("input",{type:"checkbox",checked:M.value,onChange:K},null,40,de),t[9]||(t[9]=c("span",null,"Auto Wave",-1))])],32),c("div",ve,[f.roomDetails.name!=""&&f.roomDetails.name!=null?(v(),S("div",pe,[A(' Welcome to "'+B(f.roomDetails.name)+'" Penlight Audience! ',1),t[10]||(t[10]=c("br",null,null,-1)),t[11]||(t[11]=c("br",null,null,-1))])):U("",!0),t[12]||(t[12]=A(" Drag your finger/mouse around! ",-1))]),U("",!0),c("div",Re,[ne(ue,{ref_key:"penRef",ref:d,roomDetails:f.roomDetails,color:y.value,opacity:1,penTransform:j.value,nickName:o.userRoomState.nickname||"Guest"},null,8,["roomDetails","color","penTransform","nickName"])])],544))}},ge=oe(Se,[["__scopeId","data-v-4ddf4f1f"]]),ye="wss://api.pen.lighting/ws";class ke{constructor(o,s,l,i,d=0){this.roomCode=o,this.nickname=s||"guest",this.password=l,this.wsUrl=i??this._deriveWSUrl(),this.xRef=a(-100),this.yRef=a(-100),this.thetaRef=a(0),this.colorRef=a(0),this.connectionStatusRef=a("idle"),this._socket=null,this._closedManually=!1,this._sendTimer=null,this._debounceMs=Math.max(0,d|5),this.connect(),this._wireWatches()}_deriveWSUrl(){return ye}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const o=new WebSocket(this.wsUrl);this._socket=o,o.addEventListener("open",()=>{this.connectionStatusRef.value="open";const s={type:"hello",role:"user",roomCode:this.roomCode,nickname:this.nickname};this.password!==void 0&&(s.password=this.password),o.send(JSON.stringify(s)),this._scheduleSend()}),o.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),o.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{o.close()}catch{}}),o.addEventListener("message",s=>{let l;try{l=JSON.parse(s.data)}catch{return}if(l?.type==="roomSettings"){const i=l.settings;console.log("New Settings",i),window.location.reload()}})}_wireWatches(){[this.xRef,this.yRef,this.thetaRef,this.colorRef].forEach(o=>{ae(o,()=>this._scheduleSend(),{flush:"post"})})}_scheduleSend(){!this._socket||this._socket.readyState!==WebSocket.OPEN||this._sendTimer||(this._sendTimer=setTimeout(()=>{this._sendTimer=null,this._sendUpdate()},this._debounceMs))}_sendUpdate(){if(!this._socket||this._socket.readyState!==WebSocket.OPEN)return;const o={type:"update",x:Number(this.xRef.value),y:Number(this.yRef.value),theta:Number(this.thetaRef.value),color:Number(this.colorRef.value)};try{this._socket.send(JSON.stringify(o))}catch{}}destroy(){if(this._closedManually=!0,this._sendTimer&&(clearTimeout(this._sendTimer),this._sendTimer=null),this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this.connectionStatusRef.value="closed"}}const xe={__name:"RoomView",props:{room_code:String},setup(f){const{getRoomSession:o}=me(),s=re(),l=le(),i=s.params.room_code,d=X(o(i)),p=a(null),y="wss://api.pen.lighting/ws",u=X(null);return q(async()=>{if(!d.value){l.push({name:"home",query:{room_code:i}});return}u.value=new ke(i,d.value.username,d.value.roomPwd,y),p.value=await ce()}),L(()=>{u.value&&(u.value.destroy(),u.value=null)}),(w,O)=>u.value==null||p.value==null?(v(),S(V,{key:0},[A(" Connecting... ")],64)):(v(),ie(ge,{key:1,roomDetails:p.value,userRoomState:u.value},null,8,["roomDetails","userRoomState"]))}};export{xe as default};
