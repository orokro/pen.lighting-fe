import{_ as se,r as n,p as W,o as q,a as L,c as S,b as d,l as O,d as i,j as B,A as u,F as V,x as ne,f as U,m as E,w as ae,u as le,s as X,h as re,z as ie}from"./index-BAfEQGW1.js";import{P as ue,a as ce,u as me}from"./useRoomDetails-BUpR6Crt.js";import{u as fe}from"./useRoomSession-k9OBCSQl.js";const he=["value","selected"],de={class:"checkbox"},ve=["checked"],pe={class:"hint"},Re={key:0},Se={class:"pen-container"},ge={__name:"PenRoom",props:{roomDetails:{type:Object,required:!0},userRoomState:{type:Object,required:!0}},setup(c){const o=c,a=n(null),v=n(1),m=n(1),f=n(null);function p(){const e=a.value;if(!e)return;const t=e.getBoundingClientRect();v.value=Math.max(1,t.width),m.value=Math.max(1,t.height)}const r=W(()=>_.value?o.roomDetails.penColors[o.userRoomState?.colorRef?.value]:w(o.roomDetails?.themeColor)||"FFFFFF"),_=W(()=>{const e=o.roomDetails?.penColors;return Array.isArray(e)&&e.length>0});function w(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(t=>t+t).join("")),e.length===6)?e:null)}function Y(e){return r.value===w(e)}function j(e){const t=String(e.target.value||"").replace(/^#/,"");o.userRoomState.colorRef.value=t}const z=W(()=>({x:(o.userRoomState.xRef.value??.5)*v.value,y:(o.userRoomState.yRef.value??.5)*m.value,theta:o.userRoomState.thetaRef.value}));function h(e,t,s){return Math.max(t,Math.min(s,e))}function H(e,t,s){return e+(t-e)*s}const b=n(.5),T=n(.5),x=n(0);let y=0,C=null,A=0;function k(e){const t=e/1e3;y===0&&(y=t);const s=Math.max(.001,t-y),l=h(b.value+x.value,0,1),R=C==null?0:(l-C)/s,F=(R-A)/s;let Z=h(F*18,-90,90);const ee=Number(o.userRoomState.thetaRef.value||0),te=h(s*6,0,.65),oe=H(ee,Z,te);o.userRoomState.thetaRef.value=oe,o.userRoomState.xRef.value=l,o.userRoomState.yRef.value=h(T.value,0,1),y=t,C=l,A=R}function M(e,t){const l=a.value.getBoundingClientRect(),R=h((e-l.left)/l.width,0,1),F=h((t-l.top)/l.height,0,1);b.value=R,T.value=F,k(performance.now())}function I(e){M(e.clientX,e.clientY)}function $(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&M(t.clientX,t.clientY)}function J(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&M(t.clientX,t.clientY)}function G(){}const N=n(!1);let g=null,P=0;function K(e){!!e.target.checked?Q():D()}function Q(){D(),N.value=!0,P=performance.now();const e=140/60,t=.1,s=l=>{const R=(l-P)/1e3;x.value=t*Math.sin(2*Math.PI*e*R),k(l),g=requestAnimationFrame(s)};g=requestAnimationFrame(s)}function D(){g!=null&&(cancelAnimationFrame(g),g=null),x.value=0,N.value=!1,k(performance.now())}return q(()=>{p();const e=new ResizeObserver(p);e.observe(a.value),a.value.__ro=e,Number.isFinite(o.userRoomState.xRef.value)||(o.userRoomState.xRef.value=.5),Number.isFinite(o.userRoomState.yRef.value)||(o.userRoomState.yRef.value=.5),Number.isFinite(o.userRoomState.thetaRef.value)||(o.userRoomState.thetaRef.value=0),b.value=h(Number(o.userRoomState.xRef.value),0,1),T.value=h(Number(o.userRoomState.yRef.value),0,1),k(performance.now())}),L(()=>{D();const e=a.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,t)=>(d(),S("div",{ref_key:"stageRef",ref:a,class:"room-stage",onMousemove:I,onTouchstart:$,onTouchmove:J,onTouchend:G,onContextmenu:t[8]||(t[8]=u(()=>{},["prevent"]))},[_.value?(d(),S("div",{key:0,class:"ui ui-left",onTouchstart:t[0]||(t[0]=u(()=>{},["stop"])),onTouchmove:t[1]||(t[1]=u(()=>{},["stop"])),onTouchend:t[2]||(t[2]=u(()=>{},["stop"])),onClick:t[3]||(t[3]=u(()=>{},["stop"]))},[i("select",{id:"colorSelect",class:"color-select",onChange:j},[(d(!0),S(V,null,ne(c.roomDetails.penColors,(s,l)=>(d(),S("option",{key:s,value:l,selected:Y(s)},E("#"+s.toUpperCase()),9,he))),128))],32)],32)):O("",!0),i("div",{class:"ui ui-right",onTouchstart:t[4]||(t[4]=u(()=>{},["stop"])),onTouchmove:t[5]||(t[5]=u(()=>{},["stop"])),onTouchend:t[6]||(t[6]=u(()=>{},["stop"])),onClick:t[7]||(t[7]=u(()=>{},["stop"]))},[i("label",de,[i("input",{type:"checkbox",checked:N.value,onChange:K},null,40,ve),t[9]||(t[9]=i("span",null,"Auto Wave",-1))])],32),i("div",pe,[c.roomDetails.name!=""&&c.roomDetails.name!=null?(d(),S("div",Re,[U(' Welcome to "'+E(c.roomDetails.name)+'" Penlight Audience! ',1),t[10]||(t[10]=i("br",null,null,-1)),t[11]||(t[11]=i("br",null,null,-1))])):O("",!0),t[12]||(t[12]=U(" Drag your finger/mouse around! ",-1))]),B(ue,{penlightRefs:[f.value]},null,8,["penlightRefs"]),i("div",Se,[B(ce,{ref_key:"penRef",ref:f,roomDetails:c.roomDetails,color:r.value,opacity:1,penTransform:z.value,nickName:o.userRoomState.nickname||"Guest"},null,8,["roomDetails","color","penTransform","nickName"])])],544))}},ye=se(ge,[["__scopeId","data-v-9e81c2d5"]]);class ke{constructor(o,a,v,m,f=0){this.roomCode=o,this.nickname=a||"guest",this.password=v,this.wsUrl=m??this._deriveWSUrl(),this.xRef=n(-100),this.yRef=n(-100),this.thetaRef=n(0),this.colorRef=n(0),this.connectionStatusRef=n("idle"),this._socket=null,this._closedManually=!1,this._sendTimer=null,this._debounceMs=Math.max(0,f|5),this.connect(),this._wireWatches()}_deriveWSUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//api.${window.location.host}`}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const o=new WebSocket(this.wsUrl);this._socket=o,o.addEventListener("open",()=>{this.connectionStatusRef.value="open";const a={type:"hello",role:"user",roomCode:this.roomCode,nickname:this.nickname};this.password!==void 0&&(a.password=this.password),o.send(JSON.stringify(a)),this._scheduleSend()}),o.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),o.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{o.close()}catch{}})}_wireWatches(){[this.xRef,this.yRef,this.thetaRef,this.colorRef].forEach(o=>{ae(o,()=>this._scheduleSend(),{flush:"post"})})}_scheduleSend(){!this._socket||this._socket.readyState!==WebSocket.OPEN||this._sendTimer||(this._sendTimer=setTimeout(()=>{this._sendTimer=null,this._sendUpdate()},this._debounceMs))}_sendUpdate(){if(!this._socket||this._socket.readyState!==WebSocket.OPEN)return;const o={type:"update",x:Number(this.xRef.value),y:Number(this.yRef.value),theta:Number(this.thetaRef.value),color:Number(this.colorRef.value)};try{this._socket.send(JSON.stringify(o))}catch{}}destroy(){if(this._closedManually=!0,this._sendTimer&&(clearTimeout(this._sendTimer),this._sendTimer=null),this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this.connectionStatusRef.value="closed"}}const _e="wss://api.pen.lighting/ws",Ce={__name:"RoomView",props:{room_code:String},setup(c){const{getRoomSession:o}=fe(),a=le(),v=re(),m=a.params.room_code,f=X(o(m)),p=n(null),r=X(null);return q(async()=>{if(!f.value){v.push({name:"home",query:{room_code:m}});return}r.value=new ke(m,f.value.username,f.value.roomPwd,_e),p.value=await me()}),L(()=>{r.value&&(r.value.destroy(),r.value=null)}),(_,w)=>r.value==null||p.value==null?(d(),S(V,{key:0},[U(" Connecting... ")],64)):(d(),ie(ye,{key:1,roomDetails:p.value,userRoomState:r.value},null,8,["roomDetails","userRoomState"]))}};export{Ce as default};
