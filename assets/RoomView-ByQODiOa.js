import{_ as se,r as a,p as F,o as q,a as V,c as g,b as v,l as E,d as c,j as B,A as m,F as Y,x as ne,f as U,m as X,w as ae,u as le,s as L,h as re,z as ie}from"./index-qxyoSWbH.js";import{P as ue,a as ce,u as me}from"./useRoomDetails-D6qq1pkc.js";import{u as fe}from"./useRoomSession-k9OBCSQl.js";const he=["value","selected"],de={class:"checkbox"},ve=["checked"],pe={class:"hint"},Re={key:0},ge={class:"pen-container"},Se={__name:"PenRoom",props:{roomDetails:{type:Object,required:!0},userRoomState:{type:Object,required:!0}},setup(f){const o=f,s=a(null),r=a(1),i=a(1),h=a(null);function p(){const e=s.value;if(!e)return;const t=e.getBoundingClientRect();r.value=Math.max(1,t.width),i.value=Math.max(1,t.height)}const y=F(()=>u.value?o.roomDetails.penColors[o.userRoomState?.colorRef?.value]:w(o.roomDetails?.themeColor)||"FFFFFF"),u=F(()=>{const e=o.roomDetails?.penColors;return Array.isArray(e)&&e.length>0});function w(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(t=>t+t).join("")),e.length===6)?e:null)}function A(e){return y.value===w(e)}function j(e){const t=String(e.target.value||"").replace(/^#/,"");o.userRoomState.colorRef.value=t}const z=F(()=>({x:(o.userRoomState.xRef.value??.5)*r.value,y:(o.userRoomState.yRef.value??.5)*i.value,theta:o.userRoomState.thetaRef.value}));function d(e,t,n){return Math.max(t,Math.min(n,e))}function H(e,t,n){return e+(t-e)*n}const b=a(.5),T=a(.5),x=a(0);let k=0,C=null,O=0;function _(e){const t=e/1e3;k===0&&(k=t);const n=Math.max(.001,t-k),l=d(b.value+x.value,0,1),R=C==null?0:(l-C)/n,W=(R-O)/n;let Z=d(W*18,-90,90);const ee=Number(o.userRoomState.thetaRef.value||0),te=d(n*6,0,.65),oe=H(ee,Z,te);o.userRoomState.thetaRef.value=oe,o.userRoomState.xRef.value=l,o.userRoomState.yRef.value=d(T.value,0,1),k=t,C=l,O=R}function N(e,t){const l=s.value.getBoundingClientRect(),R=d((e-l.left)/l.width,0,1),W=d((t-l.top)/l.height,0,1);b.value=R,T.value=W,_(performance.now())}function I(e){N(e.clientX,e.clientY)}function J(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&N(t.clientX,t.clientY)}function G(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&N(t.clientX,t.clientY)}function K(){}const M=a(!1);let S=null,P=0;function $(e){!!e.target.checked?Q():D()}function Q(){D(),M.value=!0,P=performance.now();const e=140/60,t=.1,n=l=>{const R=(l-P)/1e3;x.value=t*Math.sin(2*Math.PI*e*R),_(l),S=requestAnimationFrame(n)};S=requestAnimationFrame(n)}function D(){S!=null&&(cancelAnimationFrame(S),S=null),x.value=0,M.value=!1,_(performance.now())}return q(()=>{p();const e=new ResizeObserver(p);e.observe(s.value),s.value.__ro=e,Number.isFinite(o.userRoomState.xRef.value)||(o.userRoomState.xRef.value=.5),Number.isFinite(o.userRoomState.yRef.value)||(o.userRoomState.yRef.value=.5),Number.isFinite(o.userRoomState.thetaRef.value)||(o.userRoomState.thetaRef.value=0),b.value=d(Number(o.userRoomState.xRef.value),0,1),T.value=d(Number(o.userRoomState.yRef.value),0,1),_(performance.now())}),V(()=>{D();const e=s.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,t)=>(v(),g("div",{ref_key:"stageRef",ref:s,class:"room-stage",onMousemove:I,onTouchstart:J,onTouchmove:G,onTouchend:K,onContextmenu:t[8]||(t[8]=m(()=>{},["prevent"]))},[u.value?(v(),g("div",{key:0,class:"ui ui-left",onTouchstart:t[0]||(t[0]=m(()=>{},["stop"])),onTouchmove:t[1]||(t[1]=m(()=>{},["stop"])),onTouchend:t[2]||(t[2]=m(()=>{},["stop"])),onClick:t[3]||(t[3]=m(()=>{},["stop"]))},[c("select",{id:"colorSelect",class:"color-select",onChange:j},[(v(!0),g(Y,null,ne(f.roomDetails.penColors,(n,l)=>(v(),g("option",{key:n,value:l,selected:A(n)},X("#"+n.toUpperCase()),9,he))),128))],32)],32)):E("",!0),c("div",{class:"ui ui-right",onTouchstart:t[4]||(t[4]=m(()=>{},["stop"])),onTouchmove:t[5]||(t[5]=m(()=>{},["stop"])),onTouchend:t[6]||(t[6]=m(()=>{},["stop"])),onClick:t[7]||(t[7]=m(()=>{},["stop"]))},[c("label",de,[c("input",{type:"checkbox",checked:M.value,onChange:$},null,40,ve),t[9]||(t[9]=c("span",null,"Auto Wave",-1))])],32),c("div",pe,[f.roomDetails.name!=""&&f.roomDetails.name!=null?(v(),g("div",Re,[U(' Welcome to "'+X(f.roomDetails.name)+'" Penlight Audience! ',1),t[10]||(t[10]=c("br",null,null,-1)),t[11]||(t[11]=c("br",null,null,-1))])):E("",!0),t[12]||(t[12]=U(" Drag your finger/mouse around! ",-1))]),B(ue,{penlightRefs:[h.value]},null,8,["penlightRefs"]),c("div",ge,[B(ce,{ref_key:"penRef",ref:h,roomDetails:f.roomDetails,color:y.value,opacity:1,penTransform:z.value,nickName:o.userRoomState.nickname||"Guest"},null,8,["roomDetails","color","penTransform","nickName"])])],544))}},ye=se(Se,[["__scopeId","data-v-9e81c2d5"]]),ke="wss://dev.api.pen.lighting/ws";class _e{constructor(o,s,r,i,h=0){this.roomCode=o,this.nickname=s||"guest",this.password=r,this.wsUrl=i??this._deriveWSUrl(),this.xRef=a(-100),this.yRef=a(-100),this.thetaRef=a(0),this.colorRef=a(0),this.connectionStatusRef=a("idle"),this._socket=null,this._closedManually=!1,this._sendTimer=null,this._debounceMs=Math.max(0,h|5),this.connect(),this._wireWatches()}_deriveWSUrl(){return ke}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const o=new WebSocket(this.wsUrl);this._socket=o,o.addEventListener("open",()=>{this.connectionStatusRef.value="open";const s={type:"hello",role:"user",roomCode:this.roomCode,nickname:this.nickname};this.password!==void 0&&(s.password=this.password),o.send(JSON.stringify(s)),this._scheduleSend()}),o.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),o.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{o.close()}catch{}}),o.addEventListener("message",s=>{let r;try{r=JSON.parse(s.data)}catch{return}if(r?.type==="roomSettings"){const i=r.settings;console.log("New Settings",i),window.location.reload()}})}_wireWatches(){[this.xRef,this.yRef,this.thetaRef,this.colorRef].forEach(o=>{ae(o,()=>this._scheduleSend(),{flush:"post"})})}_scheduleSend(){!this._socket||this._socket.readyState!==WebSocket.OPEN||this._sendTimer||(this._sendTimer=setTimeout(()=>{this._sendTimer=null,this._sendUpdate()},this._debounceMs))}_sendUpdate(){if(!this._socket||this._socket.readyState!==WebSocket.OPEN)return;const o={type:"update",x:Number(this.xRef.value),y:Number(this.yRef.value),theta:Number(this.thetaRef.value),color:Number(this.colorRef.value)};try{this._socket.send(JSON.stringify(o))}catch{}}destroy(){if(this._closedManually=!0,this._sendTimer&&(clearTimeout(this._sendTimer),this._sendTimer=null),this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this.connectionStatusRef.value="closed"}}const Ce={__name:"RoomView",props:{room_code:String},setup(f){const{getRoomSession:o}=fe(),s=le(),r=re(),i=s.params.room_code,h=L(o(i)),p=a(null),y="wss://dev.api.pen.lighting/ws",u=L(null);return q(async()=>{if(!h.value){r.push({name:"home",query:{room_code:i}});return}u.value=new _e(i,h.value.username,h.value.roomPwd,y),p.value=await me()}),V(()=>{u.value&&(u.value.destroy(),u.value=null)}),(w,A)=>u.value==null||p.value==null?(v(),g(Y,{key:0},[U(" Connecting... ")],64)):(v(),ie(ye,{key:1,roomDetails:p.value,userRoomState:u.value},null,8,["roomDetails","userRoomState"]))}};export{Ce as default};
