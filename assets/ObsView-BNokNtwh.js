import{_ as q,r as d,i as J,p as h,w as G,o as O,a as z,c as _,b as f,l as K,j as Q,y as X,g as Y,f as U,d as Z,m as ee,F as $,x as te,z as A,s as P,u as oe,h as se}from"./index-BAfEQGW1.js";import{P as ne,a as re,u as ae}from"./useRoomDetails-BUpR6Crt.js";const le={__name:"OBSRoom",props:{roomDetails:{type:Object,required:!0},users:{type:Array,required:!0}},setup(p){const t=p,l=d(null),i=d(1),c=d(1),x=J(new Map);function S(){const e=l.value;if(!e)return;const o=e.getBoundingClientRect();i.value=Math.max(1,o.width),c.value=Math.max(1,o.height)}const y=h(()=>Math.min(256,Math.floor(c.value/4)));function k(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(o=>o+o).join("")),e.length===6)?e:null)}const M=h(()=>k(t.roomDetails?.themeColor)||"FFFFFF"),T=h(()=>Array.isArray(t.roomDetails?.penColors)&&t.roomDetails.penColors.length>0),C=h(()=>(t.roomDetails?.penColors||[]).map(k).filter(Boolean));function E(e){const o=k(e?.color);return o||(T.value&&C.value.length>0?C.value[e.color]:M.value)}const D=h(()=>t.roomDetails?.showCode||"hidden"),V=h(()=>{switch(D.value){case"top-left":return"code-top-left";case"top-right":return"code-top-right";case"bottom-left":return"code-bottom-left";case"bottom-right":return"code-bottom-right";default:return"code-hidden"}}),W=h(()=>({"--code-color":`#${M.value}`}));function j(e){const o=[],n=!!t.roomDetails?.duplicateUsers,s=Number(t.roomDetails?.duplicationThreshold||0),r=e.length;if(!n||s<=0||r>=s){for(let a=0;a<r;a++){const u=e[a];o.push({...u,opacity:1,key:`u-${a}`})}return o}const g=Math.max(0,s-r),b=Math.min(3,Math.max(1,Math.ceil(g/Math.max(1,r))));for(let a=0;a<r;a++){const u=e[a];o.push({...u,opacity:1,key:`u-${a}`});for(let m=0;m<b;m++){const F=H(a,m);o.push({...u,x:u.x+F.dx*i.value,y:u.y+F.dy*c.value,opacity:.8,key:`u-${a}-d${m}`})}}return o}function H(e,o){const n=[0,72,144,216,288],s=n[(e+o)%n.length]*Math.PI/180,r=.18+(e+o)%3*.05;return{dx:r*Math.cos(s),dy:r*Math.sin(s)}}function N(e){return Math.max(0,Math.min(1,e))}const R=d([]);let v=null;function L(e){const o=t.users.length,n=Array.from({length:o},(s,r)=>r);for(let s=o-1;s>0;s--){const r=Math.floor(Math.random()*(s+1));[n[s],n[r]]=[n[r],n[s]]}R.value=n.slice(0,e)}function B(){const e=Number(t.roomDetails?.maxConcurrent||0);if(!e||t.users.length<=e){R.value=[],w();return}L(e),w(),v=setInterval(()=>L(e),1e3)}function w(){v&&(clearInterval(v),v=null)}G(()=>[t.users.length,t.roomDetails?.maxConcurrent],()=>B(),{immediate:!0});const I=h(()=>{const e=Number(t.roomDetails?.maxConcurrent||0);let o=t.users;if(e&&o.length>e){const s=new Set(R.value);o=o.filter((r,g)=>s.has(g))}return j(o.map((s,r)=>{const g=N(Number(s.x))*(i.value-y.value)+y.value/2,b=N(Number(s.y))*(c.value-y.value)+y.value*.8,a=Number(s.theta||0),u=E(s),m=String(s.nickname||"");return{x:g,y:b,theta:a,hex:u,nickname:m,opacity:1,key:`b-${r}`}}))});return O(()=>{S();const e=new ResizeObserver(S);e.observe(l.value),l.value.__ro=e,B()}),z(()=>{w();const e=l.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,o)=>(f(),_("div",{ref_key:"stageRef",ref:l,class:"obs-stage"},[D.value!=="hidden"?(f(),_("div",{key:0,class:Y(["room-code",V.value]),style:X(W.value)},[U(ee(p.roomDetails.code)+" ",1),o[0]||(o[0]=Z("div",{class:"code-url"}," https://pen.lighting ",-1))],6)):K("",!0),Q(ne,{penlightRefs:Array.from(x.values())},null,8,["penlightRefs"]),(f(!0),_($,null,te(I.value,n=>(f(),A(re,{key:n.key,roomDetails:p.roomDetails,color:n.hex,nickName:n.nickname,opacity:n.opacity,penTransform:n,penSize:y.value,smoothMotion:!0,ref_for:!0,ref:s=>x.set(n.key,s)},null,8,["roomDetails","color","nickName","opacity","penTransform","penSize"]))),128))],512))}},ie=q(le,[["__scopeId","data-v-039c56ec"]]);class ce{constructor(t,l){this.roomCode=t,this.wsUrl=l??this._deriveWSUrl(),this._users=[],this.usersListRef=P([]),this.connectionStatusRef=d("idle"),this._socket=null,this._closedManually=!1,this.connect()}_deriveWSUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//api.${window.location.host}`}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const t=new WebSocket(this.wsUrl);this._socket=t,t.addEventListener("open",()=>{this.connectionStatusRef.value="open",t.send(JSON.stringify({type:"hello",role:"obs",roomCode:this.roomCode}))}),t.addEventListener("message",l=>{let i;try{i=JSON.parse(l.data)}catch{return}i?.type==="state"&&i?.room===this.roomCode&&Array.isArray(i.users)&&(this._users=i.users,this.usersListRef.value=[...this._users])}),t.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),t.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{t.close()}catch{}})}destroy(){if(this._closedManually=!0,this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this._users=[],this.usersListRef.value=[],this.connectionStatusRef.value="closed"}}const ue="wss://api.pen.lighting/ws",de={__name:"ObsView",props:{room_code:String},setup(p){const t=P(null),l=oe();se();const i=l.params.room_code,c=d(null);return O(async()=>{t.value=new ce(i,ue),c.value=await ae()}),z(()=>{t.value&&(t.value.destroy(),t.value=null)}),(x,S)=>t.value==null||c.value==null?(f(),_($,{key:0},[U(" Connecting... ")],64)):(f(),A(ie,{key:1,roomDetails:c.value,users:t.value.usersListRef.value},null,8,["roomDetails","users"]))}};export{de as default};
