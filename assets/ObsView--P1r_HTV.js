import{_ as j,r as d,p as u,w as q,o as L,a as O,c as v,b as f,l as J,y as G,g as K,f as z,d as Q,m as X,F as U,x as Y,z as $,s as A,u as Z,h as ee}from"./index-CcugIim5.js";import{P as te,u as oe}from"./useRoomDetails-C4ene-67.js";const se={__name:"OBSRoom",props:{roomDetails:{type:Object,required:!0},users:{type:Array,required:!0}},setup(p){const t=p,l=d(null),i=d(1),h=d(1);function x(){const e=l.value;if(!e)return;const o=e.getBoundingClientRect();i.value=Math.max(1,o.width),h.value=Math.max(1,o.height)}const w=u(()=>Math.min(256,Math.floor(h.value/4)));function S(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(o=>o+o).join("")),e.length===6)?e:null)}const C=u(()=>S(t.roomDetails?.themeColor)||"FFFFFF"),P=u(()=>Array.isArray(t.roomDetails?.penColors)&&t.roomDetails.penColors.length>0),M=u(()=>(t.roomDetails?.penColors||[]).map(S).filter(Boolean));function T(e){const o=S(e?.color);return o||(P.value&&M.value.length>0?M.value[e.color]:C.value)}const D=u(()=>t.roomDetails?.showCode||"hidden"),E=u(()=>{switch(D.value){case"top-left":return"code-top-left";case"top-right":return"code-top-right";case"bottom-left":return"code-bottom-left";case"bottom-right":return"code-bottom-right";default:return"code-hidden"}}),W=u(()=>({"--code-color":`#${C.value}`}));function H(e){const o=[],n=!!t.roomDetails?.duplicateUsers,s=Number(t.roomDetails?.duplicationThreshold||0),r=e.length;if(!n||s<=0||r>=s){for(let a=0;a<r;a++){const c=e[a];o.push({...c,opacity:1,key:`u-${a}`})}return o}const y=Math.max(0,s-r),b=Math.min(3,Math.max(1,Math.ceil(y/Math.max(1,r))));for(let a=0;a<r;a++){const c=e[a];o.push({...c,opacity:1,key:`u-${a}`});for(let m=0;m<b;m++){const F=I(a,m);o.push({...c,x:g(c.x+F.dx),y:g(c.y+F.dy),opacity:.8,key:`u-${a}-d${m}`})}}return o}function I(e,o){const n=[0,72,144,216,288],s=n[(e+o)%n.length]*Math.PI/180,r=.18+(e+o)%3*.05;return{dx:r*Math.cos(s),dy:r*Math.sin(s)}}function g(e){return Math.max(0,Math.min(1,e))}const k=d([]);let _=null;function N(e){const o=t.users.length,n=Array.from({length:o},(s,r)=>r);for(let s=o-1;s>0;s--){const r=Math.floor(Math.random()*(s+1));[n[s],n[r]]=[n[r],n[s]]}k.value=n.slice(0,e)}function B(){const e=Number(t.roomDetails?.maxConcurrent||0);if(!e||t.users.length<=e){k.value=[],R();return}N(e),R(),_=setInterval(()=>N(e),1e3)}function R(){_&&(clearInterval(_),_=null)}q(()=>[t.users.length,t.roomDetails?.maxConcurrent],()=>B(),{immediate:!0});const V=u(()=>{const e=Number(t.roomDetails?.maxConcurrent||0);let o=t.users;if(e&&o.length>e){const s=new Set(k.value);o=o.filter((r,y)=>s.has(y))}return H(o.map((s,r)=>{const y=g(Number(s.x))*i.value,b=g(Number(s.y))*h.value,a=Number(s.theta||0),c=T(s),m=String(s.nickname||"");return{x:y,y:b,theta:a,hex:c,nickname:m,opacity:1,key:`b-${r}`}}))});return L(()=>{x();const e=new ResizeObserver(x);e.observe(l.value),l.value.__ro=e,B()}),O(()=>{R();const e=l.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,o)=>(f(),v("div",{ref_key:"stageRef",ref:l,class:"obs-stage"},[D.value!=="hidden"?(f(),v("div",{key:0,class:K(["room-code",E.value]),style:G(W.value)},[z(X(p.roomDetails.code)+" ",1),o[0]||(o[0]=Q("div",{class:"code-url"}," https://pen.lighting ",-1))],6)):J("",!0),(f(!0),v(U,null,Y(V.value,n=>(f(),$(te,{key:n.key,roomDetails:p.roomDetails,color:n.hex,nickName:n.nickname,opacity:n.opacity,penTransform:n,penSize:w.value,smoothMotion:!0},null,8,["roomDetails","color","nickName","opacity","penTransform","penSize"]))),128))],512))}},ne=j(se,[["__scopeId","data-v-542473e9"]]);class re{constructor(t,l){this.roomCode=t,this.wsUrl=l??this._deriveWSUrl(),this._users=[],this.usersListRef=A([]),this.connectionStatusRef=d("idle"),this._socket=null,this._closedManually=!1,this.connect()}_deriveWSUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//api.${window.location.host}`}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const t=new WebSocket(this.wsUrl);this._socket=t,t.addEventListener("open",()=>{this.connectionStatusRef.value="open",t.send(JSON.stringify({type:"hello",role:"obs",roomCode:this.roomCode}))}),t.addEventListener("message",l=>{let i;try{i=JSON.parse(l.data)}catch{return}i?.type==="state"&&i?.room===this.roomCode&&Array.isArray(i.users)&&(this._users=i.users,this.usersListRef.value=[...this._users])}),t.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),t.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{t.close()}catch{}})}destroy(){if(this._closedManually=!0,this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this._users=[],this.usersListRef.value=[],this.connectionStatusRef.value="closed"}}const ae="wss://api.pen.lighting/ws",ce={__name:"ObsView",props:{room_code:String},setup(p){const t=A(null),l=Z();ee();const i=l.params.room_code,h=d(null);return L(async()=>{t.value=new re(i,ae),h.value=await oe()}),O(()=>{t.value&&(t.value.destroy(),t.value=null)}),(x,w)=>t.value==null||h.value==null?(f(),v(U,{key:0},[z(" Connecting... ")],64)):(f(),$(ne,{key:1,roomDetails:h.value,users:t.value.usersListRef.value},null,8,["roomDetails","users"]))}};export{ce as default};
