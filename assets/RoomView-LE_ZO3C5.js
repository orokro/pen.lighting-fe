import{_ as oe,r as l,p as R,o as X,a as z,c as _,b as d,l as se,d as r,F as B,x as ne,y as $,A as ae,m as le,w as re,k as ie,s as A,z as ue,f as ce,u as me}from"./index-C7mKpxkj.js";import{u as he}from"./useRoomDetails-C1TsaUkO.js";import{u as fe}from"./useRoomSession-k9OBCSQl.js";const de={key:0,class:"ui ui-left"},pe=["value","selected"],ve={class:"ui ui-right"},Re={class:"checkbox"},_e=["checked"],ge=["src"],O=256,Se={__name:"PenRoom",props:{roomDetails:{type:Object,required:!0},userRoomState:{type:Object,required:!0}},setup(g){const o=g,a=l(null),h=l(1),f=l(1);function u(){const e=a.value;if(!e)return;const t=e.getBoundingClientRect();h.value=Math.max(1,t.width),f.value=Math.max(1,t.height)}const i=R(()=>{const e=o.roomDetails&&o.roomDetails.penlightSprite;return e?`data:image/png;base64,${e}`:"/img/default_light.png"}),S=R(()=>b.value?o.roomDetails.penColors[o.userRoomState?.colorRef?.value]:D(o.roomDetails?.themeColor)||"FFFFFF"),b=R(()=>{const e=o.roomDetails?.penColors;return Array.isArray(e)&&e.length>0});function D(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(t=>t+t).join("")),e.length===6)?e:null)}function E(e){return S.value===D(e)}function Y(e){const t=String(e.target.value||"").replace(/^#/,"");o.userRoomState.colorRef.value=t}const q=R(()=>{const e=Number(o.userRoomState.xRef.value??.5),t=Number(o.userRoomState.yRef.value??.5),s=Number(o.userRoomState.thetaRef.value??0),n=e*h.value,m=t*f.value,v=n-O/2,P=m-O/2;return{transform:`translate(${v}px, ${P}px) rotate(${s}deg)`,"--beam-color":`#${S.value}`}}),I=R(()=>{const e=`url("${i.value}")`;return{background:`#${S.value}`,maskImage:e,maskRepeat:"no-repeat",maskSize:"256 256",maskPosition:"top left",WebkitMaskImage:e,WebkitMaskRepeat:"no-repeat",WebkitMaskSize:"256 256",WebkitMaskPosition:"top left",opacity:.7}});function c(e,t,s){return Math.max(t,Math.min(s,e))}function V(e,t,s){return e+(t-e)*s}const w=l(.5),x=l(.5),M=l(0);let y=0,C=null,F=0;function k(e){const t=e/1e3;y===0&&(y=t);const s=Math.max(.001,t-y),n=c(w.value+M.value,0,1),m=C==null?0:(n-C)/s,v=(m-F)/s;let Q=c(v*18,-90,90);const Z=Number(o.userRoomState.thetaRef.value||0),ee=c(s*6,0,.65),te=V(Z,Q,ee);o.userRoomState.thetaRef.value=te,o.userRoomState.xRef.value=n,o.userRoomState.yRef.value=c(x.value,0,1),y=t,C=n,F=m}function N(e,t){const n=a.value.getBoundingClientRect(),m=c((e-n.left)/n.width,0,1),v=c((t-n.top)/n.height,0,1);w.value=m,x.value=v,k(performance.now())}function L(e){N(e.clientX,e.clientY)}function j(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&N(t.clientX,t.clientY)}function H(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&N(t.clientX,t.clientY)}function J(){}const T=l(!1);let p=null,U=0;function K(e){!!e.target.checked?G():W()}function G(){W(),T.value=!0,U=performance.now();const e=140/60,t=.1,s=n=>{const m=(n-U)/1e3;M.value=t*Math.sin(2*Math.PI*e*m),k(n),p=requestAnimationFrame(s)};p=requestAnimationFrame(s)}function W(){p!=null&&(cancelAnimationFrame(p),p=null),M.value=0,T.value=!1,k(performance.now())}return X(()=>{u();const e=new ResizeObserver(u);e.observe(a.value),a.value.__ro=e,Number.isFinite(o.userRoomState.xRef.value)||(o.userRoomState.xRef.value=.5),Number.isFinite(o.userRoomState.yRef.value)||(o.userRoomState.yRef.value=.5),Number.isFinite(o.userRoomState.thetaRef.value)||(o.userRoomState.thetaRef.value=0),w.value=c(Number(o.userRoomState.xRef.value),0,1),x.value=c(Number(o.userRoomState.yRef.value),0,1),k(performance.now())}),z(()=>{W();const e=a.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,t)=>(d(),_("div",{ref_key:"stageRef",ref:a,class:"room-stage",onMousemove:L,onTouchstart:j,onTouchmove:H,onTouchend:J,onContextmenu:t[0]||(t[0]=ae(()=>{},["prevent"]))},[b.value?(d(),_("div",de,[t[1]||(t[1]=r("label",{class:"sr-only",for:"colorSelect"},"Penlight Color",-1)),r("select",{id:"colorSelect",class:"color-select",onChange:Y},[(d(!0),_(B,null,ne(g.roomDetails.penColors,(s,n)=>(d(),_("option",{key:s,value:n,selected:E(s)},le("#"+s.toUpperCase()),9,pe))),128))],32)])):se("",!0),r("div",ve,[r("label",Re,[r("input",{type:"checkbox",checked:T.value,onChange:K},null,40,_e),t[2]||(t[2]=r("span",null,"Auto Wave",-1))])]),t[3]||(t[3]=r("div",{class:"hint"},"drag your finger/mouse around!",-1)),r("div",{class:"light",style:$(q.value),role:"img","aria-label":"Penlight sprite"},[r("img",{class:"light__img",src:i.value,alt:"",draggable:"false"},null,8,ge),r("div",{class:"light__tint",style:$(I.value),"aria-hidden":"true"},null,4)],4)],544))}},ye=oe(Se,[["__scopeId","data-v-25d2b6ba"]]);class ke{constructor(o,a,h,f,u=0){this.roomCode=o,this.nickname=a||"guest",this.password=h,this.wsUrl=f??this._deriveWSUrl(),this.xRef=l(-100),this.yRef=l(-100),this.thetaRef=l(0),this.colorRef=l(0),this.connectionStatusRef=l("idle"),this._socket=null,this._closedManually=!1,this._sendTimer=null,this._debounceMs=Math.max(0,u|5),this.connect(),this._wireWatches()}_deriveWSUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//api.${window.location.host}`}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const o=new WebSocket(this.wsUrl);this._socket=o,o.addEventListener("open",()=>{this.connectionStatusRef.value="open";const a={type:"hello",role:"user",roomCode:this.roomCode,nickname:this.nickname};this.password!==void 0&&(a.password=this.password),o.send(JSON.stringify(a)),this._scheduleSend()}),o.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),o.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{o.close()}catch{}})}_wireWatches(){[this.xRef,this.yRef,this.thetaRef,this.colorRef].forEach(o=>{re(o,()=>this._scheduleSend(),{flush:"post"})})}_scheduleSend(){!this._socket||this._socket.readyState!==WebSocket.OPEN||this._sendTimer||(this._sendTimer=setTimeout(()=>{this._sendTimer=null,this._sendUpdate()},this._debounceMs))}_sendUpdate(){if(!this._socket||this._socket.readyState!==WebSocket.OPEN)return;const o={type:"update",x:Number(this.xRef.value),y:Number(this.yRef.value),theta:Number(this.thetaRef.value),color:Number(this.colorRef.value)};try{this._socket.send(JSON.stringify(o))}catch{}}destroy(){if(this._closedManually=!0,this._sendTimer&&(clearTimeout(this._sendTimer),this._sendTimer=null),this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this.connectionStatusRef.value="closed"}}const be="wss://api.pen.lighting/ws",Ce={__name:"RoomView",props:{room_code:String},setup(g){const{getRoomSession:o}=fe(),a=ie();me();const h=a.params.room_code,f=A(o(h)),u=l(null),i=A(null);return X(async()=>{i.value=new ke(h,f.value.username,f.value.roomPwd,be),u.value=await he()}),z(()=>{i.value&&(i.value.destroy(),i.value=null)}),(S,b)=>i.value==null||u.value==null?(d(),_(B,{key:0},[ce(" Connecting... ")],64)):(d(),ue(ye,{key:1,roomDetails:u.value,userRoomState:i.value},null,8,["roomDetails","userRoomState"]))}};export{Ce as default};
