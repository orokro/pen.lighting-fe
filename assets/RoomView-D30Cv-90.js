import{_ as Q,r,p as F,o as B,a as E,c as y,b as v,l as Z,d as p,j as ee,A as i,F as P,x as te,m as oe,w as se,u as ne,s as O,h as ae,z as re,f as le}from"./index-CcugIim5.js";import{P as ie,u as ue}from"./useRoomDetails-C4ene-67.js";import{u as ce}from"./useRoomSession-k9OBCSQl.js";const me=["value","selected"],fe={class:"checkbox"},he=["checked"],de={__name:"PenRoom",props:{roomDetails:{type:Object,required:!0},userRoomState:{type:Object,required:!0}},setup(R){const o=R,n=r(null),f=r(1),u=r(1);function c(){const e=n.value;if(!e)return;const t=e.getBoundingClientRect();f.value=Math.max(1,t.width),u.value=Math.max(1,t.height)}const h=F(()=>l.value?o.roomDetails.penColors[o.userRoomState?.colorRef?.value]:k(o.roomDetails?.themeColor)||"FFFFFF"),l=F(()=>{const e=o.roomDetails?.penColors;return Array.isArray(e)&&e.length>0});function k(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(t=>t+t).join("")),e.length===6)?e:null)}function W(e){return h.value===k(e)}function X(e){const t=String(e.target.value||"").replace(/^#/,"");o.userRoomState.colorRef.value=t}const q=F(()=>({x:(o.userRoomState.xRef.value??.5)*f.value,y:(o.userRoomState.yRef.value??.5)*u.value,theta:o.userRoomState.thetaRef.value}));function m(e,t,s){return Math.max(t,Math.min(s,e))}function V(e,t,s){return e+(t-e)*s}const w=r(.5),b=r(.5),T=r(0);let g=0,x=null,U=0;function _(e){const t=e/1e3;g===0&&(g=t);const s=Math.max(.001,t-g),a=m(w.value+T.value,0,1),d=x==null?0:(a-x)/s,D=(d-U)/s;let $=m(D*18,-90,90);const J=Number(o.userRoomState.thetaRef.value||0),G=m(s*6,0,.65),K=V(J,$,G);o.userRoomState.thetaRef.value=K,o.userRoomState.xRef.value=a,o.userRoomState.yRef.value=m(b.value,0,1),g=t,x=a,U=d}function C(e,t){const a=n.value.getBoundingClientRect(),d=m((e-a.left)/a.width,0,1),D=m((t-a.top)/a.height,0,1);w.value=d,b.value=D,_(performance.now())}function L(e){C(e.clientX,e.clientY)}function Y(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&C(t.clientX,t.clientY)}function j(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&C(t.clientX,t.clientY)}function z(){}const M=r(!1);let S=null,A=0;function H(e){!!e.target.checked?I():N()}function I(){N(),M.value=!0,A=performance.now();const e=140/60,t=.1,s=a=>{const d=(a-A)/1e3;T.value=t*Math.sin(2*Math.PI*e*d),_(a),S=requestAnimationFrame(s)};S=requestAnimationFrame(s)}function N(){S!=null&&(cancelAnimationFrame(S),S=null),T.value=0,M.value=!1,_(performance.now())}return B(()=>{c();const e=new ResizeObserver(c);e.observe(n.value),n.value.__ro=e,Number.isFinite(o.userRoomState.xRef.value)||(o.userRoomState.xRef.value=.5),Number.isFinite(o.userRoomState.yRef.value)||(o.userRoomState.yRef.value=.5),Number.isFinite(o.userRoomState.thetaRef.value)||(o.userRoomState.thetaRef.value=0),w.value=m(Number(o.userRoomState.xRef.value),0,1),b.value=m(Number(o.userRoomState.yRef.value),0,1),_(performance.now())}),E(()=>{N();const e=n.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,t)=>(v(),y("div",{ref_key:"stageRef",ref:n,class:"room-stage",onMousemove:L,onTouchstart:Y,onTouchmove:j,onTouchend:z,onContextmenu:t[8]||(t[8]=i(()=>{},["prevent"]))},[l.value?(v(),y("div",{key:0,class:"ui ui-left",onTouchstart:t[0]||(t[0]=i(()=>{},["stop"])),onTouchmove:t[1]||(t[1]=i(()=>{},["stop"])),onTouchend:t[2]||(t[2]=i(()=>{},["stop"])),onClick:t[3]||(t[3]=i(()=>{},["stop"]))},[p("select",{id:"colorSelect",class:"color-select",onChange:X},[(v(!0),y(P,null,te(R.roomDetails.penColors,(s,a)=>(v(),y("option",{key:s,value:a,selected:W(s)},oe("#"+s.toUpperCase()),9,me))),128))],32)],32)):Z("",!0),p("div",{class:"ui ui-right",onTouchstart:t[4]||(t[4]=i(()=>{},["stop"])),onTouchmove:t[5]||(t[5]=i(()=>{},["stop"])),onTouchend:t[6]||(t[6]=i(()=>{},["stop"])),onClick:t[7]||(t[7]=i(()=>{},["stop"]))},[p("label",fe,[p("input",{type:"checkbox",checked:M.value,onChange:H},null,40,he),t[9]||(t[9]=p("span",null,"Auto Wave",-1))])],32),t[10]||(t[10]=p("div",{class:"hint"},"Drag your finger/mouse around!",-1)),ee(ie,{roomDetails:R.roomDetails,color:h.value,opacity:1,penTransform:q.value,nickName:o.userRoomState.nickname||"Guest"},null,8,["roomDetails","color","penTransform","nickName"])],544))}},pe=Q(de,[["__scopeId","data-v-c3e19456"]]);class ve{constructor(o,n,f,u,c=0){this.roomCode=o,this.nickname=n||"guest",this.password=f,this.wsUrl=u??this._deriveWSUrl(),this.xRef=r(-100),this.yRef=r(-100),this.thetaRef=r(0),this.colorRef=r(0),this.connectionStatusRef=r("idle"),this._socket=null,this._closedManually=!1,this._sendTimer=null,this._debounceMs=Math.max(0,c|5),this.connect(),this._wireWatches()}_deriveWSUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//api.${window.location.host}`}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const o=new WebSocket(this.wsUrl);this._socket=o,o.addEventListener("open",()=>{this.connectionStatusRef.value="open";const n={type:"hello",role:"user",roomCode:this.roomCode,nickname:this.nickname};this.password!==void 0&&(n.password=this.password),o.send(JSON.stringify(n)),this._scheduleSend()}),o.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),o.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{o.close()}catch{}})}_wireWatches(){[this.xRef,this.yRef,this.thetaRef,this.colorRef].forEach(o=>{se(o,()=>this._scheduleSend(),{flush:"post"})})}_scheduleSend(){!this._socket||this._socket.readyState!==WebSocket.OPEN||this._sendTimer||(this._sendTimer=setTimeout(()=>{this._sendTimer=null,this._sendUpdate()},this._debounceMs))}_sendUpdate(){if(!this._socket||this._socket.readyState!==WebSocket.OPEN)return;const o={type:"update",x:Number(this.xRef.value),y:Number(this.yRef.value),theta:Number(this.thetaRef.value),color:Number(this.colorRef.value)};try{this._socket.send(JSON.stringify(o))}catch{}}destroy(){if(this._closedManually=!0,this._sendTimer&&(clearTimeout(this._sendTimer),this._sendTimer=null),this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this.connectionStatusRef.value="closed"}}const Re="wss://api.pen.lighting/ws",ke={__name:"RoomView",props:{room_code:String},setup(R){const{getRoomSession:o}=ce(),n=ne(),f=ae(),u=n.params.room_code,c=O(o(u)),h=r(null),l=O(null);return B(async()=>{if(!c.value){f.push({name:"home",query:{room_code:u}});return}l.value=new ve(u,c.value.username,c.value.roomPwd,Re),h.value=await ue()}),E(()=>{l.value&&(l.value.destroy(),l.value=null)}),(k,W)=>l.value==null||h.value==null?(v(),y(P,{key:0},[le(" Connecting... ")],64)):(v(),re(pe,{key:1,roomDetails:h.value,userRoomState:l.value},null,8,["roomDetails","userRoomState"]))}};export{ke as default};
