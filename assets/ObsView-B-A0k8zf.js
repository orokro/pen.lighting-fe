import{_ as I,r as v,o as B,a as T,c as M,b as y,i as J,p as f,w as G,l as K,j as Q,y as X,g as Y,f as $,d as Z,m as ee,F as H,x as te,z as q,s as V,u as oe,h as se}from"./index-CV9c4C8w.js";import{P as ne,u as re}from"./useRoomDetails-DQnv8edM.js";const ae={__name:"PenLightTrails",props:{penlightRefs:{type:Array,required:!0}},setup(p,{expose:t}){const c=p,n=v(null);let i=null,d=null,g=0;function h(r){const{width:_,height:w}=r.canvas;r.save(),r.globalCompositeOperation="destination-in",r.globalAlpha=.98,r.fillRect(0,0,_,w),r.restore(),g++%10===0&&k(r,27),c.penlightRefs?.length&&c.penlightRefs.forEach(x=>{x?.drawPenTrail(r)})}function k(r,_=10){const{width:w,height:x}=r.canvas,L=r.getImageData(0,0,w,x),b=L.data;for(let R=3;R<b.length;R+=4)b[R]<_&&(b[R]=0);r.putImageData(L,0,0)}function C(){i&&(h(i),d=requestAnimationFrame(C))}B(()=>{const r=n.value;r&&(r.width=window.innerWidth,r.height=window.innerHeight,i=r.getContext("2d",{willReadFrequently:!0}),C(),window.addEventListener("resize",N))}),T(()=>{d&&cancelAnimationFrame(d),window.removeEventListener("resize",N)});function N(){n.value&&(n.value.width=window.innerWidth,n.value.height=window.innerHeight)}return t({drawTrail:h}),(r,_)=>(y(),M("canvas",{ref_key:"trailCanvas",ref:n,class:"trail-canvas"},null,512))}},ie=I(ae,[["__scopeId","data-v-5934fd7a"]]),le={__name:"OBSRoom",props:{roomDetails:{type:Object,required:!0},users:{type:Array,required:!0}},setup(p){const t=p,c=v(null),n=v(1),i=v(1),d=J(new Map);function g(){const e=c.value;if(!e)return;const o=e.getBoundingClientRect();n.value=Math.max(1,o.width),i.value=Math.max(1,o.height)}const h=f(()=>Math.min(256,Math.floor(i.value/4)));function k(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(o=>o+o).join("")),e.length===6)?e:null)}const C=f(()=>k(t.roomDetails?.themeColor)||"FFFFFF"),N=f(()=>Array.isArray(t.roomDetails?.penColors)&&t.roomDetails.penColors.length>0),r=f(()=>(t.roomDetails?.penColors||[]).map(k).filter(Boolean));function _(e){const o=k(e?.color);return o||(N.value&&r.value.length>0?r.value[e.color]:C.value)}const w=f(()=>t.roomDetails?.showCode||"hidden"),x=f(()=>{switch(w.value){case"top-left":return"code-top-left";case"top-right":return"code-top-right";case"bottom-left":return"code-bottom-left";case"bottom-right":return"code-bottom-right";default:return"code-hidden"}}),L=f(()=>({"--code-color":`#${C.value}`}));function b(e){const o=[],a=!!t.roomDetails?.duplicateUsers,s=Number(t.roomDetails?.duplicationThreshold||0),l=e.length;if(!a||s<=0||l>=s){for(let u=0;u<l;u++){const m=e[u];o.push({...m,opacity:1,key:`u-${u}`})}return o}const D=Math.max(0,s-l),O=Math.min(3,Math.max(1,Math.ceil(D/Math.max(1,l))));for(let u=0;u<l;u++){const m=e[u];o.push({...m,opacity:1,key:`u-${u}`});for(let S=0;S<O;S++){const E=R(u,S);o.push({...m,x:m.x+E.dx*n.value,y:m.y+E.dy*i.value,opacity:.8,key:`u-${u}-d${S}`})}}return o}function R(e,o){const a=[0,72,144,216,288],s=a[(e+o)%a.length]*Math.PI/180,l=.18+(e+o)%3*.05;return{dx:l*Math.cos(s),dy:l*Math.sin(s)}}function U(e){return Math.max(0,Math.min(1,e))}const z=v([]);let F=null;function W(e){const o=t.users.length,a=Array.from({length:o},(s,l)=>l);for(let s=o-1;s>0;s--){const l=Math.floor(Math.random()*(s+1));[a[s],a[l]]=[a[l],a[s]]}z.value=a.slice(0,e)}function P(){const e=Number(t.roomDetails?.maxConcurrent||0);if(!e||t.users.length<=e){z.value=[],A();return}W(e),A(),F=setInterval(()=>W(e),1e3)}function A(){F&&(clearInterval(F),F=null)}G(()=>[t.users.length,t.roomDetails?.maxConcurrent],()=>P(),{immediate:!0});const j=f(()=>{const e=Number(t.roomDetails?.maxConcurrent||0);let o=t.users;if(e&&o.length>e){const s=new Set(z.value);o=o.filter((l,D)=>s.has(D))}return b(o.map((s,l)=>{const D=U(Number(s.x))*(n.value-h.value)+h.value/2,O=U(Number(s.y))*(i.value-h.value)+h.value*.8,u=Number(s.theta||0),m=_(s),S=String(s.nickname||"");return{x:D,y:O,theta:u,hex:m,nickname:S,opacity:1,key:`b-${l}`}}))});return B(()=>{g();const e=new ResizeObserver(g);e.observe(c.value),c.value.__ro=e,P()}),T(()=>{A();const e=c.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,o)=>(y(),M("div",{ref_key:"stageRef",ref:c,class:"obs-stage"},[w.value!=="hidden"?(y(),M("div",{key:0,class:Y(["room-code",x.value]),style:X(L.value)},[$(ee(p.roomDetails.code)+" ",1),o[0]||(o[0]=Z("div",{class:"code-url"}," https://pen.lighting ",-1))],6)):K("",!0),Q(ie,{penlightRefs:Array.from(d.values())},null,8,["penlightRefs"]),(y(!0),M(H,null,te(j.value,a=>(y(),q(ne,{key:a.key,roomDetails:p.roomDetails,color:a.hex,nickName:a.nickname,opacity:a.opacity,penTransform:a,penSize:h.value,smoothMotion:!0,ref_for:!0,ref:s=>d.set(a.key,s)},null,8,["roomDetails","color","nickName","opacity","penTransform","penSize"]))),128))],512))}},ce=I(le,[["__scopeId","data-v-039c56ec"]]),ue="wss://api.pen.lighting/ws";class he{constructor(t,c,n){this.roomCode=t,this.roomDetails=c,this.wsUrl=n??this._deriveWSUrl(),this._users=[],this.usersListRef=V([]),this.connectionStatusRef=v("idle"),this._socket=null,this._closedManually=!1,this.connect()}_deriveWSUrl(){return ue}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const t=new WebSocket(this.wsUrl);this._socket=t,t.addEventListener("open",()=>{this.connectionStatusRef.value="open",t.send(JSON.stringify({type:"hello",role:"obs",roomCode:this.roomCode}))}),t.addEventListener("message",c=>{let n;try{n=JSON.parse(c.data)}catch{return}if(n?.type==="state"&&n?.room===this.roomCode&&Array.isArray(n.users)&&(this._users=n.users,this.usersListRef.value=[...this._users]),n?.type==="roomSettings"){const i=n.settings;console.log("New Settings",i),this.roomDetails.value=i,window.location.reload()}}),t.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),t.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{t.close()}catch{}})}destroy(){if(this._closedManually=!0,this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this._users=[],this.usersListRef.value=[],this.connectionStatusRef.value="closed"}}const fe={__name:"ObsView",props:{room_code:String},setup(p){const t=V(null),c=oe();se();const n=c.params.room_code,i=v(null),d="wss://api.pen.lighting/ws";return B(async()=>{const g=await re();i.value=g,t.value=new he(n,i,d)}),T(()=>{t.value&&(t.value.destroy(),t.value=null)}),(g,h)=>t.value==null||i.value==null?(y(),M(H,{key:0},[$(" Connecting... ")],64)):(y(),q(ce,{key:1,roomDetails:i.value,users:t.value.usersListRef.value},null,8,["roomDetails","users"]))}};export{fe as default};
