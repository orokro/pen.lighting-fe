import{_ as q,r as _,o as O,a as U,c as N,b as y,y as H,i as K,p,w as Q,l as E,z as A,g as X,f as j,d as Y,m as Z,F as V,x as ee,s as J,u as te,h as oe}from"./index-SdmsmDou.js";import{P as se,u as ne}from"./useRoomDetails-BTokwxwp.js";const ae={__name:"PenLightTrails",props:{penlightRefs:{type:Array,required:!0},intensity:{type:Number,required:!1,default:.5},decay:{type:Number,required:!1,default:.5}},setup(d,{expose:t}){const r=d,n=_(null);let c=null,m=null,g=0;function h(a){const{width:S,height:R}=a.canvas;let v=.98*r.decay;r.decay>.5&&(v=.98+(r.decay-.5)*2*.02),v=.85+r.decay*(.99-.85),a.save(),a.globalCompositeOperation="destination-in",a.globalAlpha=v,a.fillRect(0,0,S,R),a.restore(),g++%10===0&&b(a,27),r.penlightRefs?.length&&r.penlightRefs.forEach(w=>{w?.drawPenTrail(a)})}function b(a,S=10){const{width:R,height:v}=a.canvas,w=a.getImageData(0,0,R,v),x=w.data;for(let D=3;D<x.length;D+=4)x[D]<S&&(x[D]=0);a.putImageData(w,0,0)}function C(){c&&(h(c),m=requestAnimationFrame(C))}O(()=>{const a=n.value;a&&(a.width=window.innerWidth,a.height=window.innerHeight,c=a.getContext("2d",{willReadFrequently:!0}),C(),window.addEventListener("resize",L))}),U(()=>{m&&cancelAnimationFrame(m),window.removeEventListener("resize",L)});function L(){n.value&&(n.value.width=window.innerWidth,n.value.height=window.innerHeight)}return t({drawTrail:h}),(a,S)=>(y(),N("canvas",{ref_key:"trailCanvas",ref:n,class:"trail-canvas",style:H({opacity:d.intensity})},null,4))}},re=q(ae,[["__scopeId","data-v-6f91f5d6"]]),ie={__name:"OBSRoom",props:{roomDetails:{type:Object,required:!0},users:{type:Array,required:!0}},setup(d){const t=d,r=_(null),n=_(1),c=_(1),m=K(new Map);function g(){const e=r.value;if(!e)return;const o=e.getBoundingClientRect();n.value=Math.max(1,o.width),c.value=Math.max(1,o.height)}const h=p(()=>Math.floor((t.roomDetails?.penScale||1)*256));function b(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(o=>o+o).join("")),e.length===6)?e:null)}const C=p(()=>b(t.roomDetails?.themeColor)||"FFFFFF"),L=p(()=>Array.isArray(t.roomDetails?.penColors)&&t.roomDetails.penColors.length>0),a=p(()=>(t.roomDetails?.penColors||[]).map(b).filter(Boolean));function S(e){const o=b(e?.color);return o||(L.value&&a.value.length>0?a.value[e.color]:C.value)}const R=p(()=>t.roomDetails?.showCode||"hidden"),v=p(()=>{switch(R.value){case"top-left":return"code-top-left";case"top-right":return"code-top-right";case"bottom-left":return"code-bottom-left";case"bottom-right":return"code-bottom-right";default:return"code-hidden"}}),w=p(()=>({"--code-color":`#${C.value}`,transform:`scale(${Number(t.roomDetails?.showCodeScale||1)})`}));function x(e){const o=[],i=!!t.roomDetails?.duplicateUsers,s=Number(t.roomDetails?.duplicationThreshold||0),l=e.length;if(!i||s<=0||l>=s){for(let u=0;u<l;u++){const f=e[u];o.push({...f,opacity:1,key:`u-${u}`})}return o}const M=Math.max(0,s-l),T=Math.min(3,Math.max(1,Math.ceil(M/Math.max(1,l))));for(let u=0;u<l;u++){const f=e[u];o.push({...f,opacity:1,key:`u-${u}`});for(let k=0;k<T;k++){const $=D(u,k);o.push({...f,x:f.x+$.dx*n.value,y:f.y+$.dy*c.value,opacity:.8,key:`u-${u}-d${k}`})}}return o}function D(e,o){const i=[0,72,144,216,288],s=i[(e+o)%i.length]*Math.PI/180,l=.18+(e+o)%3*.05;return{dx:l*Math.cos(s),dy:l*Math.sin(s)}}function W(e){return Math.max(0,Math.min(1,e))}const B=_([]);let z=null;function I(e){const o=t.users.length,i=Array.from({length:o},(s,l)=>l);for(let s=o-1;s>0;s--){const l=Math.floor(Math.random()*(s+1));[i[s],i[l]]=[i[l],i[s]]}B.value=i.slice(0,e)}function P(){const e=Number(t.roomDetails?.maxConcurrent||0);if(!e||t.users.length<=e){B.value=[],F();return}I(e),F(),z=setInterval(()=>I(e),1e3)}function F(){z&&(clearInterval(z),z=null)}Q(()=>[t.users.length,t.roomDetails?.maxConcurrent],()=>P(),{immediate:!0});const G=p(()=>{const e=Number(t.roomDetails?.maxConcurrent||0);let o=t.users;if(e&&o.length>e){const s=new Set(B.value);o=o.filter((l,M)=>s.has(M))}return x(o.map((s,l)=>{const M=W(Number(s.x))*(n.value-h.value)+h.value/2,T=W(Number(s.y))*(c.value-h.value)+h.value*.8,u=Number(s.theta||0),f=S(s),k=String(s.nickname||"");return{x:M,y:T,theta:u,hex:f,nickname:k,opacity:1,key:`b-${l}`}}))});return O(()=>{console.log("OBSRoom mounted",t.roomDetails),g();const e=new ResizeObserver(g);e.observe(r.value),r.value.__ro=e,P()}),U(()=>{F();const e=r.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,o)=>(y(),N("div",{ref_key:"stageRef",ref:r,class:"obs-stage"},[R.value!=="hidden"?(y(),N("div",{key:0,class:X(["room-code",v.value]),style:H(w.value)},[j(Z(d.roomDetails.code)+" ",1),o[0]||(o[0]=Y("div",{class:"code-url"}," https://pen.lighting ",-1))],6)):E("",!0),d.roomDetails?.penTrails?(y(),A(re,{key:1,penlightRefs:Array.from(m.values()),intensity:d.roomDetails?.penTrailsIntensity||.5,decay:d.roomDetails?.penTrailsDecay||.5},null,8,["penlightRefs","intensity","decay"])):E("",!0),(y(!0),N(V,null,ee(G.value,i=>(y(),A(se,{key:i.key,roomDetails:d.roomDetails,color:i.hex,nickName:i.nickname,opacity:i.opacity,penTransform:i,penSize:h.value,smoothMotion:!0,ref_for:!0,ref:s=>m.set(i.key,s)},null,8,["roomDetails","color","nickName","opacity","penTransform","penSize"]))),128))],512))}},le=q(ie,[["__scopeId","data-v-85a237be"]]),ce="wss://api.pen.lighting/ws";class ue{constructor(t,r,n){this.roomCode=t,this.roomDetails=r,this.wsUrl=n??this._deriveWSUrl(),this._users=[],this.usersListRef=J([]),this.connectionStatusRef=_("idle"),this._socket=null,this._closedManually=!1,this.connect()}_deriveWSUrl(){return ce}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const t=new WebSocket(this.wsUrl);this._socket=t,t.addEventListener("open",()=>{this.connectionStatusRef.value="open",t.send(JSON.stringify({type:"hello",role:"obs",roomCode:this.roomCode}))}),t.addEventListener("message",r=>{let n;try{n=JSON.parse(r.data)}catch{return}if(n?.type==="state"&&n?.room===this.roomCode&&Array.isArray(n.users)&&(this._users=n.users,this.usersListRef.value=[...this._users]),n?.type==="roomSettings"){const c=n.settings;console.log("New Settings",c),this.roomDetails.value=c,window.location.reload()}}),t.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),t.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{t.close()}catch{}})}destroy(){if(this._closedManually=!0,this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this._users=[],this.usersListRef.value=[],this.connectionStatusRef.value="closed"}}const me={__name:"ObsView",props:{room_code:String},setup(d){const t=J(null),r=te();oe();const n=r.params.room_code,c=_(null),m="wss://api.pen.lighting/ws";return O(async()=>{const g=await ne();c.value=g,t.value=new ue(n,c,m)}),U(()=>{t.value&&(t.value.destroy(),t.value=null)}),(g,h)=>t.value==null||c.value==null?(y(),N(V,{key:0},[j(" Connecting... ")],64)):(y(),A(le,{key:1,roomDetails:c.value,users:t.value.usersListRef.value},null,8,["roomDetails","users"]))}};export{me as default};
