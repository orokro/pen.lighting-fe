import{_ as j,r as d,p as h,w as q,o as L,a as O,c as _,b as f,l as J,y as G,g as K,f as z,d as Q,m as X,F as U,x as Y,z as $,s as A,u as Z,h as ee}from"./index-D10ls-BZ.js";import{P as te,u as oe}from"./useRoomDetails-BP9qMEWD.js";const se={__name:"OBSRoom",props:{roomDetails:{type:Object,required:!0},users:{type:Array,required:!0}},setup(p){const t=p,l=d(null),i=d(1),c=d(1);function v(){const e=l.value;if(!e)return;const o=e.getBoundingClientRect();i.value=Math.max(1,o.width),c.value=Math.max(1,o.height)}const b=h(()=>Math.min(256,Math.floor(c.value/4)));function x(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(o=>o+o).join("")),e.length===6)?e:null)}const w=h(()=>x(t.roomDetails?.themeColor)||"FFFFFF"),P=h(()=>Array.isArray(t.roomDetails?.penColors)&&t.roomDetails.penColors.length>0),C=h(()=>(t.roomDetails?.penColors||[]).map(x).filter(Boolean));function T(e){const o=x(e?.color);return o||(P.value&&C.value.length>0?C.value[e.color]:w.value)}const M=h(()=>t.roomDetails?.showCode||"hidden"),E=h(()=>{switch(M.value){case"top-left":return"code-top-left";case"top-right":return"code-top-right";case"bottom-left":return"code-bottom-left";case"bottom-right":return"code-bottom-right";default:return"code-hidden"}}),W=h(()=>({"--code-color":`#${w.value}`}));function H(e){const o=[],n=!!t.roomDetails?.duplicateUsers,s=Number(t.roomDetails?.duplicationThreshold||0),r=e.length;if(!n||s<=0||r>=s){for(let a=0;a<r;a++){const u=e[a];o.push({...u,opacity:1,key:`u-${a}`})}return o}const y=Math.max(0,s-r),R=Math.min(3,Math.max(1,Math.ceil(y/Math.max(1,r))));for(let a=0;a<r;a++){const u=e[a];o.push({...u,opacity:1,key:`u-${a}`});for(let m=0;m<R;m++){const F=I(a,m);o.push({...u,x:u.x+F.dx*i.value,y:u.y+F.dy*c.value,opacity:.8,key:`u-${a}-d${m}`})}}return o}function I(e,o){const n=[0,72,144,216,288],s=n[(e+o)%n.length]*Math.PI/180,r=.18+(e+o)%3*.05;return{dx:r*Math.cos(s),dy:r*Math.sin(s)}}function D(e){return Math.max(0,Math.min(1,e))}const S=d([]);let g=null;function N(e){const o=t.users.length,n=Array.from({length:o},(s,r)=>r);for(let s=o-1;s>0;s--){const r=Math.floor(Math.random()*(s+1));[n[s],n[r]]=[n[r],n[s]]}S.value=n.slice(0,e)}function B(){const e=Number(t.roomDetails?.maxConcurrent||0);if(!e||t.users.length<=e){S.value=[],k();return}N(e),k(),g=setInterval(()=>N(e),1e3)}function k(){g&&(clearInterval(g),g=null)}q(()=>[t.users.length,t.roomDetails?.maxConcurrent],()=>B(),{immediate:!0});const V=h(()=>{const e=Number(t.roomDetails?.maxConcurrent||0);let o=t.users;if(e&&o.length>e){const s=new Set(S.value);o=o.filter((r,y)=>s.has(y))}return H(o.map((s,r)=>{const y=D(Number(s.x))*i.value,R=D(Number(s.y))*c.value,a=Number(s.theta||0),u=T(s),m=String(s.nickname||"");return{x:y,y:R,theta:a,hex:u,nickname:m,opacity:1,key:`b-${r}`}}))});return L(()=>{v();const e=new ResizeObserver(v);e.observe(l.value),l.value.__ro=e,B()}),O(()=>{k();const e=l.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,o)=>(f(),_("div",{ref_key:"stageRef",ref:l,class:"obs-stage"},[M.value!=="hidden"?(f(),_("div",{key:0,class:K(["room-code",E.value]),style:G(W.value)},[z(X(p.roomDetails.code)+" ",1),o[0]||(o[0]=Q("div",{class:"code-url"}," https://pen.lighting ",-1))],6)):J("",!0),(f(!0),_(U,null,Y(V.value,n=>(f(),$(te,{key:n.key,roomDetails:p.roomDetails,color:n.hex,nickName:n.nickname,opacity:n.opacity,penTransform:n,penSize:b.value,smoothMotion:!0},null,8,["roomDetails","color","nickName","opacity","penTransform","penSize"]))),128))],512))}},ne=j(se,[["__scopeId","data-v-fa7941cb"]]);class re{constructor(t,l){this.roomCode=t,this.wsUrl=l??this._deriveWSUrl(),this._users=[],this.usersListRef=A([]),this.connectionStatusRef=d("idle"),this._socket=null,this._closedManually=!1,this.connect()}_deriveWSUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//api.${window.location.host}`}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const t=new WebSocket(this.wsUrl);this._socket=t,t.addEventListener("open",()=>{this.connectionStatusRef.value="open",t.send(JSON.stringify({type:"hello",role:"obs",roomCode:this.roomCode}))}),t.addEventListener("message",l=>{let i;try{i=JSON.parse(l.data)}catch{return}i?.type==="state"&&i?.room===this.roomCode&&Array.isArray(i.users)&&(this._users=i.users,this.usersListRef.value=[...this._users])}),t.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),t.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{t.close()}catch{}})}destroy(){if(this._closedManually=!0,this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this._users=[],this.usersListRef.value=[],this.connectionStatusRef.value="closed"}}const ae="wss://api.pen.lighting/ws",ce={__name:"ObsView",props:{room_code:String},setup(p){const t=A(null),l=Z();ee();const i=l.params.room_code,c=d(null);return L(async()=>{t.value=new re(i,ae),c.value=await oe()}),O(()=>{t.value&&(t.value.destroy(),t.value=null)}),(v,b)=>t.value==null||c.value==null?(f(),_(U,{key:0},[z(" Connecting... ")],64)):(f(),$(ne,{key:1,roomDetails:c.value,users:t.value.usersListRef.value},null,8,["roomDetails","users"]))}};export{ce as default};
