import{_ as ee,r,p as F,o as E,a as X,c as S,b as f,l as O,d as R,j as te,A as i,F as q,x as oe,m as P,w as se,u as ne,s as B,h as ae,z as re,f as le}from"./index-CCQZgtHY.js";import{P as ie,u as ue}from"./useRoomDetails-BRcnZPvC.js";import{u as ce}from"./useRoomSession-k9OBCSQl.js";const me=["value","selected"],he={class:"checkbox"},fe=["checked"],de={key:1,class:"title"},ve={__name:"PenRoom",props:{roomDetails:{type:Object,required:!0},userRoomState:{type:Object,required:!0}},setup(u){const o=u,n=r(null),d=r(1),c=r(1);function m(){const e=n.value;if(!e)return;const t=e.getBoundingClientRect();d.value=Math.max(1,t.width),c.value=Math.max(1,t.height)}const v=F(()=>l.value?o.roomDetails.penColors[o.userRoomState?.colorRef?.value]:_(o.roomDetails?.themeColor)||"FFFFFF"),l=F(()=>{const e=o.roomDetails?.penColors;return Array.isArray(e)&&e.length>0});function _(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(t=>t+t).join("")),e.length===6)?e:null)}function W(e){return v.value===_(e)}function V(e){const t=String(e.target.value||"").replace(/^#/,"");o.userRoomState.colorRef.value=t}const L=F(()=>({x:(o.userRoomState.xRef.value??.5)*d.value,y:(o.userRoomState.yRef.value??.5)*c.value,theta:o.userRoomState.thetaRef.value}));function h(e,t,s){return Math.max(t,Math.min(s,e))}function Y(e,t,s){return e+(t-e)*s}const w=r(.5),b=r(.5),T=r(0);let g=0,x=null,U=0;function k(e){const t=e/1e3;g===0&&(g=t);const s=Math.max(.001,t-g),a=h(w.value+T.value,0,1),p=x==null?0:(a-x)/s,D=(p-U)/s;let G=h(D*18,-90,90);const K=Number(o.userRoomState.thetaRef.value||0),Q=h(s*6,0,.65),Z=Y(K,G,Q);o.userRoomState.thetaRef.value=Z,o.userRoomState.xRef.value=a,o.userRoomState.yRef.value=h(b.value,0,1),g=t,x=a,U=p}function C(e,t){const a=n.value.getBoundingClientRect(),p=h((e-a.left)/a.width,0,1),D=h((t-a.top)/a.height,0,1);w.value=p,b.value=D,k(performance.now())}function j(e){C(e.clientX,e.clientY)}function z(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&C(t.clientX,t.clientY)}function H(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&C(t.clientX,t.clientY)}function I(){}const M=r(!1);let y=null,A=0;function $(e){!!e.target.checked?J():N()}function J(){N(),M.value=!0,A=performance.now();const e=140/60,t=.1,s=a=>{const p=(a-A)/1e3;T.value=t*Math.sin(2*Math.PI*e*p),k(a),y=requestAnimationFrame(s)};y=requestAnimationFrame(s)}function N(){y!=null&&(cancelAnimationFrame(y),y=null),T.value=0,M.value=!1,k(performance.now())}return E(()=>{m();const e=new ResizeObserver(m);e.observe(n.value),n.value.__ro=e,Number.isFinite(o.userRoomState.xRef.value)||(o.userRoomState.xRef.value=.5),Number.isFinite(o.userRoomState.yRef.value)||(o.userRoomState.yRef.value=.5),Number.isFinite(o.userRoomState.thetaRef.value)||(o.userRoomState.thetaRef.value=0),w.value=h(Number(o.userRoomState.xRef.value),0,1),b.value=h(Number(o.userRoomState.yRef.value),0,1),k(performance.now())}),X(()=>{N();const e=n.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,t)=>(f(),S("div",{ref_key:"stageRef",ref:n,class:"room-stage",onMousemove:j,onTouchstart:z,onTouchmove:H,onTouchend:I,onContextmenu:t[8]||(t[8]=i(()=>{},["prevent"]))},[l.value?(f(),S("div",{key:0,class:"ui ui-left",onTouchstart:t[0]||(t[0]=i(()=>{},["stop"])),onTouchmove:t[1]||(t[1]=i(()=>{},["stop"])),onTouchend:t[2]||(t[2]=i(()=>{},["stop"])),onClick:t[3]||(t[3]=i(()=>{},["stop"]))},[R("select",{id:"colorSelect",class:"color-select",onChange:V},[(f(!0),S(q,null,oe(u.roomDetails.penColors,(s,a)=>(f(),S("option",{key:s,value:a,selected:W(s)},P("#"+s.toUpperCase()),9,me))),128))],32)],32)):O("",!0),R("div",{class:"ui ui-right",onTouchstart:t[4]||(t[4]=i(()=>{},["stop"])),onTouchmove:t[5]||(t[5]=i(()=>{},["stop"])),onTouchend:t[6]||(t[6]=i(()=>{},["stop"])),onClick:t[7]||(t[7]=i(()=>{},["stop"]))},[R("label",he,[R("input",{type:"checkbox",checked:M.value,onChange:$},null,40,fe),t[9]||(t[9]=R("span",null,"Auto Wave",-1))])],32),t[10]||(t[10]=R("div",{class:"hint"},"Drag your finger/mouse around!",-1)),u.roomDetails.name!=""&&u.roomDetails.name!=null?(f(),S("div",de,' Welcome to "'+P(u.roomDetails.name)+'" Penlight Audience! ',1)):O("",!0),te(ie,{roomDetails:u.roomDetails,color:v.value,opacity:1,penTransform:L.value,nickName:o.userRoomState.nickname||"Guest"},null,8,["roomDetails","color","penTransform","nickName"])],544))}},pe=ee(ve,[["__scopeId","data-v-7e576d6e"]]);class Re{constructor(o,n,d,c,m=0){this.roomCode=o,this.nickname=n||"guest",this.password=d,this.wsUrl=c??this._deriveWSUrl(),this.xRef=r(-100),this.yRef=r(-100),this.thetaRef=r(0),this.colorRef=r(0),this.connectionStatusRef=r("idle"),this._socket=null,this._closedManually=!1,this._sendTimer=null,this._debounceMs=Math.max(0,m|5),this.connect(),this._wireWatches()}_deriveWSUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//api.${window.location.host}`}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const o=new WebSocket(this.wsUrl);this._socket=o,o.addEventListener("open",()=>{this.connectionStatusRef.value="open";const n={type:"hello",role:"user",roomCode:this.roomCode,nickname:this.nickname};this.password!==void 0&&(n.password=this.password),o.send(JSON.stringify(n)),this._scheduleSend()}),o.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),o.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{o.close()}catch{}})}_wireWatches(){[this.xRef,this.yRef,this.thetaRef,this.colorRef].forEach(o=>{se(o,()=>this._scheduleSend(),{flush:"post"})})}_scheduleSend(){!this._socket||this._socket.readyState!==WebSocket.OPEN||this._sendTimer||(this._sendTimer=setTimeout(()=>{this._sendTimer=null,this._sendUpdate()},this._debounceMs))}_sendUpdate(){if(!this._socket||this._socket.readyState!==WebSocket.OPEN)return;const o={type:"update",x:Number(this.xRef.value),y:Number(this.yRef.value),theta:Number(this.thetaRef.value),color:Number(this.colorRef.value)};try{this._socket.send(JSON.stringify(o))}catch{}}destroy(){if(this._closedManually=!0,this._sendTimer&&(clearTimeout(this._sendTimer),this._sendTimer=null),this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this.connectionStatusRef.value="closed"}}const Se="wss://api.pen.lighting/ws",we={__name:"RoomView",props:{room_code:String},setup(u){const{getRoomSession:o}=ce(),n=ne(),d=ae(),c=n.params.room_code,m=B(o(c)),v=r(null),l=B(null);return E(async()=>{if(!m.value){d.push({name:"home",query:{room_code:c}});return}l.value=new Re(c,m.value.username,m.value.roomPwd,Se),v.value=await ue()}),X(()=>{l.value&&(l.value.destroy(),l.value=null)}),(_,W)=>l.value==null||v.value==null?(f(),S(q,{key:0},[le(" Connecting... ")],64)):(f(),re(pe,{key:1,roomDetails:v.value,userRoomState:l.value},null,8,["roomDetails","userRoomState"]))}};export{we as default};
