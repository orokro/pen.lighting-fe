import{r as s,w as h,k as d,s as l,o as m,a as f,c as _,b as p,d as r,m as c,u as R}from"./index-DSsJm8DN.js";import{u as S}from"./useRoomDetails-DmG4IGp2.js";import{u as v}from"./useRoomSession-k9OBCSQl.js";class w{constructor(e,t,n,o,a=5){this.roomCode=e,this.nickname=t||"guest",this.password=n,this.wsUrl=o??this._deriveWSUrl(),this.xRef=s(-100),this.yRef=s(-100),this.thetaRef=s(0),this.colorRef=s(0),this.connectionStatusRef=s("idle"),this._socket=null,this._closedManually=!1,this._sendTimer=null,this._debounceMs=Math.max(0,a|0),this.connect(),this._wireWatches()}_deriveWSUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//api.${window.location.host}`}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const e=new WebSocket(this.wsUrl);this._socket=e,e.addEventListener("open",()=>{this.connectionStatusRef.value="open";const t={type:"hello",role:"user",roomCode:this.roomCode,nickname:this.nickname};this.password!==void 0&&(t.password=this.password),e.send(JSON.stringify(t)),this._scheduleSend()}),e.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),e.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{e.close()}catch{}})}_wireWatches(){[this.xRef,this.yRef,this.thetaRef,this.colorRef].forEach(e=>{h(e,()=>this._scheduleSend(),{flush:"post"})})}_scheduleSend(){!this._socket||this._socket.readyState!==WebSocket.OPEN||this._sendTimer||(this._sendTimer=setTimeout(()=>{this._sendTimer=null,this._sendUpdate()},this._debounceMs))}_sendUpdate(){if(!this._socket||this._socket.readyState!==WebSocket.OPEN)return;const e={type:"update",x:Number(this.xRef.value),y:Number(this.yRef.value),theta:Number(this.thetaRef.value),color:Number(this.colorRef.value)};try{this._socket.send(JSON.stringify(e))}catch{}}destroy(){if(this._closedManually=!0,this._sendTimer&&(clearTimeout(this._sendTimer),this._sendTimer=null),this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this.connectionStatusRef.value="closed"}}const y="wss://api.pen.lighting/ws",U={__name:"RoomView",setup(u){const{getRoomSession:e}=v(),t=d();R();const n=t.params.room_code,o=l(e(n)),a=s(null),i=l(null);return m(async()=>{i.value=new w(n,o.value.username,o.value.roomPwd,y),console.log("New UserRoomState:",i.value),a.value=await S()}),f(()=>{i.value&&(i.value.destroy(),i.value=null)}),(k,g)=>(p(),_("div",null,[r("pre",null,c(JSON.stringify(o.value,null,2)),1),r("pre",null,c(JSON.stringify(a.value,null,2)),1)]))}};export{U as default};
