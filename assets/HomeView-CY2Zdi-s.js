import{_ as z,r as a,s as D,w as G,o as W,n as I,a as K,c as Q,b as X,d as s,e as P,f as Y,v as S,g as j,u as Z}from"./index-DSsJm8DN.js";import{u as oo}from"./useRoomSession-k9OBCSQl.js";const eo={class:"home-view"},to={class:"row-contents"},no=["maxlength"],so={class:"row-contents"},ao={class:"row-contents"},lo=["disabled"],ro={__name:"HomeView",setup(io){const r=a(""),i=a(""),u=a(""),m=a(!1),l=a(!1),y=a(!1),c=a(!1),d=a(null),h=a(!1),b=a(""),k=a(""),_=a(null),N=a(null),E=a(null),F=Z(),{saveRoomSession:T}=oo();let p=null,R=0,f=null,x=0;const C=D(!1);G([l,u],()=>{const e=!!l.value&&String(u.value||"").trim().length>0;C.value=e,y.value=e},{immediate:!0});function U(){b.value="",k.value="",g(),w(),V(),B({keepNickValue:!0});const e=String(r.value||"").trim();e.length===6&&$(e)}function A(){if(k.value="",w(),v(),!c.value||!d.value)return;const e=String(r.value||"").trim(),o=String(i.value||"");e.length===6&&o.length===d.value&&L(e,o)}function q(){}function V(){m.value=!1,c.value=!1,d.value=null,i.value=""}function B({keepNickValue:e}){v()}function v(){l.value=!1,y.value=!1}function O(){I(()=>N.value?.focus?.())}function J(){I(()=>E.value?.focus?.())}async function $(e){g(),R++;const o=R;p=new AbortController;try{const t=await fetch(`https://api.pen.lighting/rooms/${encodeURIComponent(e)}`,{method:"GET",signal:p.signal});if(o!==R)return;if(!t.ok)throw new Error(t.status===404?"Room not found":"Room lookup failed");const n=await t.json();c.value=!!n.isProtected,d.value=Number(n.pwLength)||null,c.value?(m.value=!0,O()):(m.value=!1,l.value=!0,J())}catch(t){if(t?.name==="AbortError")return;b.value=t?.message||"Room lookup failed",V(),v()}finally{g()}}function g(){if(p){try{p.abort()}catch{}p=null}}async function L(e,o){w(),x++;const t=x;f=new AbortController;try{const n=await fetch(`https://api.pen.lighting/users/join/${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:o,nick:""}),signal:f.signal});if(t!==x)return;if(!n.ok)throw new Error(n.status===403?"Incorrect password":"Password check failed");if(!(await n.json())?.ok)throw new Error("Password check failed");l.value=!0,J()}catch(n){if(n?.name==="AbortError")return;k.value=n?.message||"Password check failed",v()}finally{w()}}function w(){if(f){try{f.abort()}catch{}f=null}}async function H(){if(!C.value||h.value)return;const e=String(r.value||"").trim(),o=String(i.value||""),t=String(u.value||"").trim();h.value=!0;try{const n=await fetch(`https://api.pen.lighting/users/join/${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:o,nick:t})});if(!n.ok)throw new Error("Failed to join room");if(!(await n.json())?.ok)throw new Error("Failed to join room");T(e,o,t),await F.push({path:`/room/${e}`})}catch(n){c.value?(k.value=n?.message||"Failed to join",v()):b.value=n?.message||"Failed to join"}finally{h.value=!1}}return W(()=>{I(()=>_.value?.focus?.())}),K(()=>{g(),w()}),(e,o)=>(X(),Q("div",eo,[o[6]||(o[6]=s("div",{class:"text-row"},[Y(" Join a room! "),s("span",{class:"material-icons arrow"},"redo")],-1)),P(s("input",{ref_key:"roomCodeInput",ref:_,"onUpdate:modelValue":o[0]||(o[0]=t=>r.value=t),type:"text",placeholder:"Room Code",class:"room-code-input big-input",maxlength:"6",onInput:U},null,544),[[S,r.value]]),s("div",{class:j(["password-row row",{expanded:m.value}])},[s("div",to,[o[3]||(o[3]=s("div",{class:"text-row"}," Enter private room PW: ",-1)),P(s("input",{ref_key:"passwordInput",ref:N,"onUpdate:modelValue":o[1]||(o[1]=t=>i.value=t),type:"text",placeholder:"Password",class:"room-code-input big-input",maxlength:d.value||null,onInput:A},null,40,no),[[S,i.value]])])],2),s("div",{class:j(["nick-row row",{expanded:l.value}])},[s("div",so,[o[4]||(o[4]=s("div",{class:"text-row"}," Pick a nick: ",-1)),P(s("input",{ref_key:"nickInput",ref:E,"onUpdate:modelValue":o[2]||(o[2]=t=>u.value=t),type:"text",placeholder:"Nickname",class:"room-code-input big-input",onInput:q},null,544),[[S,u.value]])])],2),s("div",{class:j(["join-row row",{expanded:y.value}])},[s("div",ao,[o[5]||(o[5]=s("div",{class:"text-row"}," Rock & roll! ",-1)),s("button",{class:"join-button big-button",disabled:!C.value||h.value,onClick:H}," ~~ Join Room ~~ ",8,lo)])],2)]))}},po=z(ro,[["__scopeId","data-v-98a4f22f"]]);export{po as default};
