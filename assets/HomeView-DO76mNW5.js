import{_ as G,r as a,o as q,u as W,s as K,w as Q,n as _,a as X,c as Y,b as Z,d as s,e as P,f as oo,v as S,g as j,h as eo}from"./index-Ocpc1JRF.js";import{u as to}from"./useRoomSession-k9OBCSQl.js";const no={class:"home-view"},so={class:"row-contents"},ao=["maxlength"],ro={class:"row-contents"},lo={class:"row-contents"},io=["disabled"],uo={__name:"HomeView",setup(co){const r=a(""),i=a(""),u=a(""),w=a(!1),l=a(!1),y=a(!1),c=a(!1),d=a(null),h=a(!1),R=a(""),g=a(""),N=a(null),E=a(null),V=a(null),U=eo(),{saveRoomSession:A}=to(),b=W();q(()=>{b?.query?.room_code&&(console.log("room code",b.query.room_code),r.value=String(b.query.room_code||"").trim().slice(0,6)),J()});let p=null,x=0,f=null,C=0;const I=K(!1);Q([l,u],()=>{const e=!!l.value&&String(u.value||"").trim().length>0;I.value=e,y.value=e},{immediate:!0});function J(){R.value="",g.value="",k(),v(),F(),$({keepNickValue:!0});const e=String(r.value||"").trim();e.length===6&&H(e)}function B(){if(g.value="",v(),m(),!c.value||!d.value)return;const e=String(r.value||"").trim(),o=String(i.value||"");e.length===6&&o.length===d.value&&M(e,o)}function O(){}function F(){w.value=!1,c.value=!1,d.value=null,i.value=""}function $({keepNickValue:e}){m()}function m(){l.value=!1,y.value=!1}function L(){_(()=>E.value?.focus?.())}function T(){_(()=>V.value?.focus?.())}async function H(e){k(),x++;const o=x;p=new AbortController;try{const t=await fetch(`https://api.pen.lighting/rooms/${encodeURIComponent(e)}`,{method:"GET",signal:p.signal});if(o!==x)return;if(!t.ok)throw new Error(t.status===404?"Room not found":"Room lookup failed");const n=await t.json();c.value=!!n.isProtected,d.value=Number(n.pwLength)||null,c.value?(w.value=!0,L()):(w.value=!1,l.value=!0,T())}catch(t){if(t?.name==="AbortError")return;R.value=t?.message||"Room lookup failed",F(),m()}finally{k()}}function k(){if(p){try{p.abort()}catch{}p=null}}async function M(e,o){v(),C++;const t=C;f=new AbortController;try{const n=await fetch(`https://api.pen.lighting/users/join/${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:o,nick:""}),signal:f.signal});if(t!==C)return;if(!n.ok)throw new Error(n.status===403?"Incorrect password":"Password check failed");if(!(await n.json())?.ok)throw new Error("Password check failed");l.value=!0,T()}catch(n){if(n?.name==="AbortError")return;g.value=n?.message||"Password check failed",m()}finally{v()}}function v(){if(f){try{f.abort()}catch{}f=null}}async function z(){if(!I.value||h.value)return;const e=String(r.value||"").trim(),o=String(i.value||""),t=String(u.value||"").trim();h.value=!0;try{const n=await fetch(`https://api.pen.lighting/users/join/${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:o,nick:t})});if(!n.ok)throw new Error("Failed to join room");if(!(await n.json())?.ok)throw new Error("Failed to join room");A(e,o,t),await U.push({path:`/room/${e}`})}catch(n){c.value?(g.value=n?.message||"Failed to join",m()):R.value=n?.message||"Failed to join"}finally{h.value=!1}}return q(()=>{_(()=>N.value?.focus?.())}),X(()=>{k(),v()}),(e,o)=>(Z(),Y("div",no,[o[6]||(o[6]=s("div",{class:"text-row"},[oo(" Join a room! "),s("span",{class:"material-icons arrow"},"redo")],-1)),P(s("input",{ref_key:"roomCodeInput",ref:N,"onUpdate:modelValue":o[0]||(o[0]=t=>r.value=t),type:"text",placeholder:"Room Code",class:"room-code-input big-input",maxlength:"6",onInput:J},null,544),[[S,r.value]]),s("div",{class:j(["password-row row",{expanded:w.value}])},[s("div",so,[o[3]||(o[3]=s("div",{class:"text-row"}," Enter private room PW: ",-1)),P(s("input",{ref_key:"passwordInput",ref:E,"onUpdate:modelValue":o[1]||(o[1]=t=>i.value=t),type:"text",placeholder:"Password",class:"room-code-input big-input",maxlength:d.value||null,onInput:B},null,40,ao),[[S,i.value]])])],2),s("div",{class:j(["nick-row row",{expanded:l.value}])},[s("div",ro,[o[4]||(o[4]=s("div",{class:"text-row"}," Pick a nick: ",-1)),P(s("input",{ref_key:"nickInput",ref:V,"onUpdate:modelValue":o[2]||(o[2]=t=>u.value=t),type:"text",placeholder:"Nickname",class:"room-code-input big-input",maxlength:"16",onInput:O},null,544),[[S,u.value]])])],2),s("div",{class:j(["join-row row",{expanded:y.value}])},[s("div",lo,[o[5]||(o[5]=s("div",{class:"text-row"}," Rock & roll! ",-1)),s("button",{class:"join-button big-button",disabled:!I.value||h.value,onClick:z}," ~~ Join Room ~~ ",8,io)])],2)]))}},mo=G(uo,[["__scopeId","data-v-1f268ec3"]]);export{mo as default};
