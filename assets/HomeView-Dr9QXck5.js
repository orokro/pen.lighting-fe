import{_ as W,r as a,o as q,u as K,s as Q,w as X,n as _,a as Y,c as Z,b as oo,d as s,e as S,f as eo,v as j,g as N,h as to}from"./index-DA3b5Kw_.js";import{u as no}from"./useRoomSession-k9OBCSQl.js";const so={class:"home-view"},ao={class:"row-contents"},ro=["maxlength"],lo={class:"row-contents"},io={class:"row-contents"},uo=["disabled"],co={__name:"HomeView",setup(po){const r=a(""),i=a(""),u=a(""),w=a(!1),l=a(!1),y=a(!1),c=a(!1),d=a(null),h=a(!1),R=a(""),k=a(""),E=a(null),V=a(null),J=a(null),A=to(),{saveRoomSession:$}=no(),b=K();q(()=>{b?.query?.room_code&&(console.log("room code",b.query.room_code),r.value=String(b.query.room_code||"").trim().slice(0,6)),F()});const x="https://api.pen.lighting";let p=null,I=0,f=null,C=0;const P=Q(!1);X([l,u],()=>{const e=!!l.value&&String(u.value||"").trim().length>0;P.value=e,y.value=e},{immediate:!0});function F(){R.value="",k.value="",g(),m(),T(),L({keepNickValue:!0});const e=String(r.value||"").trim();e.length===6&&M(e)}function B(){if(k.value="",m(),v(),!c.value||!d.value)return;const e=String(r.value||"").trim(),o=String(i.value||"");e.length===6&&o.length===d.value&&z(e,o)}function O(){}function T(){w.value=!1,c.value=!1,d.value=null,i.value=""}function L({keepNickValue:e}){v()}function v(){l.value=!1,y.value=!1}function H(){_(()=>V.value?.focus?.())}function U(){_(()=>J.value?.focus?.())}async function M(e){g(),I++;const o=I;p=new AbortController;try{const t=await fetch(`${x}/rooms/${encodeURIComponent(e)}`,{method:"GET",signal:p.signal});if(o!==I)return;if(!t.ok)throw new Error(t.status===404?"Room not found":"Room lookup failed");const n=await t.json();c.value=!!n.isProtected,d.value=Number(n.pwLength)||null,c.value?(w.value=!0,H()):(w.value=!1,l.value=!0,U())}catch(t){if(t?.name==="AbortError")return;R.value=t?.message||"Room lookup failed",T(),v()}finally{g()}}function g(){if(p){try{p.abort()}catch{}p=null}}async function z(e,o){m(),C++;const t=C;f=new AbortController;try{const n=await fetch(`${x}/users/join/${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:o,nick:""}),signal:f.signal});if(t!==C)return;if(!n.ok)throw new Error(n.status===403?"Incorrect password":"Password check failed");if(!(await n.json())?.ok)throw new Error("Password check failed");l.value=!0,U()}catch(n){if(n?.name==="AbortError")return;k.value=n?.message||"Password check failed",v()}finally{m()}}function m(){if(f){try{f.abort()}catch{}f=null}}async function D(){if(!P.value||h.value)return;const e=String(r.value||"").trim(),o=String(i.value||""),t=String(u.value||"").trim();h.value=!0;try{const n=await fetch(`${x}/users/join/${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:o,nick:t})});if(!n.ok)throw new Error("Failed to join room");if(!(await n.json())?.ok)throw new Error("Failed to join room");$(e,o,t),await A.push({path:`/room/${e}`})}catch(n){c.value?(k.value=n?.message||"Failed to join",v()):R.value=n?.message||"Failed to join"}finally{h.value=!1}}return q(()=>{_(()=>E.value?.focus?.())}),Y(()=>{g(),m()}),(e,o)=>(oo(),Z("div",so,[o[6]||(o[6]=s("div",{class:"text-row"},[eo(" Join a room! "),s("span",{class:"material-icons arrow"},"redo")],-1)),S(s("input",{ref_key:"roomCodeInput",ref:E,"onUpdate:modelValue":o[0]||(o[0]=t=>r.value=t),type:"text",placeholder:"Room Code",class:"room-code-input big-input",maxlength:"6",onInput:F},null,544),[[j,r.value]]),s("div",{class:N(["password-row row",{expanded:w.value}])},[s("div",ao,[o[3]||(o[3]=s("div",{class:"text-row"}," Enter private room PW: ",-1)),S(s("input",{ref_key:"passwordInput",ref:V,"onUpdate:modelValue":o[1]||(o[1]=t=>i.value=t),type:"text",placeholder:"Password",class:"room-code-input big-input",maxlength:d.value||null,onInput:B},null,40,ro),[[j,i.value]])])],2),s("div",{class:N(["nick-row row",{expanded:l.value}])},[s("div",lo,[o[4]||(o[4]=s("div",{class:"text-row"}," Pick a nick: ",-1)),S(s("input",{ref_key:"nickInput",ref:J,"onUpdate:modelValue":o[2]||(o[2]=t=>u.value=t),type:"text",placeholder:"Nickname",class:"room-code-input big-input",maxlength:"16",onInput:O},null,544),[[j,u.value]])])],2),s("div",{class:N(["join-row row",{expanded:y.value}])},[s("div",io,[o[5]||(o[5]=s("div",{class:"text-row"}," Rock & roll! ",-1)),s("button",{class:"join-button big-button",disabled:!P.value||h.value,onClick:D}," ~~ Join Room ~~ ",8,uo)])],2)]))}},mo=W(co,[["__scopeId","data-v-a84805e2"]]);export{mo as default};
