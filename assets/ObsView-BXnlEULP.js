import{_ as q,r as f,i as J,p as h,w as G,o as O,a as U,c as x,b as p,l as K,j as Q,y as X,g as Y,f as z,d as Z,m as ee,F as A,x as te,z as P,s as T,u as oe,h as se}from"./index-If-UVuQK.js";import{P as ne,a as re,u as ae}from"./useRoomDetails-CQmVVYaq.js";const le={__name:"OBSRoom",props:{roomDetails:{type:Object,required:!0},users:{type:Array,required:!0}},setup(y){const t=y,c=f(null),a=f(1),i=f(1),_=J(new Map);function g(){const e=c.value;if(!e)return;const o=e.getBoundingClientRect();a.value=Math.max(1,o.width),i.value=Math.max(1,o.height)}const m=h(()=>Math.min(256,Math.floor(i.value/4)));function k(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(o=>o+o).join("")),e.length===6)?e:null)}const M=h(()=>k(t.roomDetails?.themeColor)||"FFFFFF"),W=h(()=>Array.isArray(t.roomDetails?.penColors)&&t.roomDetails.penColors.length>0),C=h(()=>(t.roomDetails?.penColors||[]).map(k).filter(Boolean));function $(e){const o=k(e?.color);return o||(W.value&&C.value.length>0?C.value[e.color]:M.value)}const D=h(()=>t.roomDetails?.showCode||"hidden"),E=h(()=>{switch(D.value){case"top-left":return"code-top-left";case"top-right":return"code-top-right";case"bottom-left":return"code-bottom-left";case"bottom-right":return"code-bottom-right";default:return"code-hidden"}}),V=h(()=>({"--code-color":`#${M.value}`}));function j(e){const o=[],n=!!t.roomDetails?.duplicateUsers,s=Number(t.roomDetails?.duplicationThreshold||0),r=e.length;if(!n||s<=0||r>=s){for(let l=0;l<r;l++){const u=e[l];o.push({...u,opacity:1,key:`u-${l}`})}return o}const v=Math.max(0,s-r),b=Math.min(3,Math.max(1,Math.ceil(v/Math.max(1,r))));for(let l=0;l<r;l++){const u=e[l];o.push({...u,opacity:1,key:`u-${l}`});for(let d=0;d<b;d++){const F=H(l,d);o.push({...u,x:u.x+F.dx*a.value,y:u.y+F.dy*i.value,opacity:.8,key:`u-${l}-d${d}`})}}return o}function H(e,o){const n=[0,72,144,216,288],s=n[(e+o)%n.length]*Math.PI/180,r=.18+(e+o)%3*.05;return{dx:r*Math.cos(s),dy:r*Math.sin(s)}}function N(e){return Math.max(0,Math.min(1,e))}const R=f([]);let S=null;function L(e){const o=t.users.length,n=Array.from({length:o},(s,r)=>r);for(let s=o-1;s>0;s--){const r=Math.floor(Math.random()*(s+1));[n[s],n[r]]=[n[r],n[s]]}R.value=n.slice(0,e)}function B(){const e=Number(t.roomDetails?.maxConcurrent||0);if(!e||t.users.length<=e){R.value=[],w();return}L(e),w(),S=setInterval(()=>L(e),1e3)}function w(){S&&(clearInterval(S),S=null)}G(()=>[t.users.length,t.roomDetails?.maxConcurrent],()=>B(),{immediate:!0});const I=h(()=>{const e=Number(t.roomDetails?.maxConcurrent||0);let o=t.users;if(e&&o.length>e){const s=new Set(R.value);o=o.filter((r,v)=>s.has(v))}return j(o.map((s,r)=>{const v=N(Number(s.x))*(a.value-m.value)+m.value/2,b=N(Number(s.y))*(i.value-m.value)+m.value*.8,l=Number(s.theta||0),u=$(s),d=String(s.nickname||"");return{x:v,y:b,theta:l,hex:u,nickname:d,opacity:1,key:`b-${r}`}}))});return O(()=>{g();const e=new ResizeObserver(g);e.observe(c.value),c.value.__ro=e,B()}),U(()=>{w();const e=c.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,o)=>(p(),x("div",{ref_key:"stageRef",ref:c,class:"obs-stage"},[D.value!=="hidden"?(p(),x("div",{key:0,class:Y(["room-code",E.value]),style:X(V.value)},[z(ee(y.roomDetails.code)+" ",1),o[0]||(o[0]=Z("div",{class:"code-url"}," https://pen.lighting ",-1))],6)):K("",!0),Q(ne,{penlightRefs:Array.from(_.values())},null,8,["penlightRefs"]),(p(!0),x(A,null,te(I.value,n=>(p(),P(re,{key:n.key,roomDetails:y.roomDetails,color:n.hex,nickName:n.nickname,opacity:n.opacity,penTransform:n,penSize:m.value,smoothMotion:!0,ref_for:!0,ref:s=>_.set(n.key,s)},null,8,["roomDetails","color","nickName","opacity","penTransform","penSize"]))),128))],512))}},ie=q(le,[["__scopeId","data-v-039c56ec"]]),ce="wss://api.pen.lighting/ws";class ue{constructor(t,c,a){this.roomCode=t,this.roomDetails=c,this.wsUrl=a??this._deriveWSUrl(),this._users=[],this.usersListRef=T([]),this.connectionStatusRef=f("idle"),this._socket=null,this._closedManually=!1,this.connect()}_deriveWSUrl(){return ce}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const t=new WebSocket(this.wsUrl);this._socket=t,t.addEventListener("open",()=>{this.connectionStatusRef.value="open",t.send(JSON.stringify({type:"hello",role:"obs",roomCode:this.roomCode}))}),t.addEventListener("message",c=>{let a;try{a=JSON.parse(c.data)}catch{return}if(a?.type==="state"&&a?.room===this.roomCode&&Array.isArray(a.users)&&(this._users=a.users,this.usersListRef.value=[...this._users]),a?.type==="roomSettings"){const i=a.settings;console.log("New Settings",i),this.roomDetails.value=i,window.location.reload()}}),t.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),t.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{t.close()}catch{}})}destroy(){if(this._closedManually=!0,this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this._users=[],this.usersListRef.value=[],this.connectionStatusRef.value="closed"}}const de={__name:"ObsView",props:{room_code:String},setup(y){const t=T(null),c=oe();se();const a=c.params.room_code,i=f(null),_="wss://api.pen.lighting/ws";return O(async()=>{const g=await ae();i.value=g,t.value=new ue(a,i,_)}),U(()=>{t.value&&(t.value.destroy(),t.value=null)}),(g,m)=>t.value==null||i.value==null?(p(),x(A,{key:0},[z(" Connecting... ")],64)):(p(),P(ie,{key:1,roomDetails:i.value,users:t.value.usersListRef.value},null,8,["roomDetails","users"]))}};export{de as default};
