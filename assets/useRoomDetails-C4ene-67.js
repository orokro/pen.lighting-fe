import{_ as U,r as F,p as N,s as G,o as O,c as H,b as K,d as b,y as R,g as C,m as X,u as V}from"./index-CcugIim5.js";function W(){const s=new Map;function i(){s.clear()}function m(t){if(!t)return;const e=`${t}::`;for(const a of s.keys())a.startsWith(e)&&s.delete(a)}function d(t){return new Promise((e,a)=>{const n=new Image;n.crossOrigin="anonymous",n.decoding="async",n.onload=()=>e(n),n.onerror=u=>a(new Error("Failed to load image: "+t)),n.src=t})}function p(t){const a=document.createElement("canvas");a.width=256,a.height=256;const n=a.getContext("2d",{willReadFrequently:!0});return n.drawImage(t,0,0,256,256),{canvas:a,ctx:n}}function h(t){if(!t)return"#DDDDDD";let e=String(t).trim();return e[0]!=="#"&&(e="#"+e),e.length===4&&(e="#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]),/^#([0-9a-fA-F]{6})$/.test(e)?e.toUpperCase():"#DDDDDD"}function l(t){const e=parseInt(t.slice(1),16);return{r:e>>16&255,g:e>>8&255,b:e&255}}function r(t,e,a,n,u){const o=1-u;return{r:Math.round(t*o+n.r*u),g:Math.round(e*o+n.g*u),b:Math.round(a*o+n.b*u)}}function g(t,e,a){const{width:n,height:u,data:o}=t;let D=!1;const k=new ImageData(n,u),f=k.data,$=0,P=255,T=0,M=Math.max(0,Number.isFinite(e)?e:0);for(let c=0;c<o.length;c+=4){const w=o[c],I=o[c+1],_=o[c+2],S=o[c+3];if(S===0)continue;const L=w-$,A=I-P,B=_-T,E=Math.sqrt(L*L+A*A+B*B);let x=0;if(M===0?w===0&&I===255&&_===0&&(x=1):E<=M&&(x=1-E/M),x>0){D=!0;const j=Math.round(S*x);f[c]=255,f[c+1]=255,f[c+2]=255,f[c+3]=j;const q=r(w,I,_,a,x);o[c]=q.r,o[c+1]=q.g,o[c+2]=q.b}}return{foundGreen:D,editedImageData:t,maskImageData:D?k:null}}function v(t){const e=document.createElement("canvas");return e.width=t.width,e.height=t.height,e.getContext("2d").putImageData(t,0,0),e.toDataURL("image/png")}function y(t,e,a=0,n="#DDDDDD"){if(!t||!e)return Promise.reject(new Error("getPenImages(roomCode, spriteSrc) requires both parameters."));const u=h(n),o=`${t}::${e}::${a}::${u}`;if(s.has(o))return s.get(o);const D=(async()=>{const k=await d(e),{canvas:f,ctx:$}=p(k),P=$.getImageData(0,0,f.width,f.height),T=l(u),{foundGreen:M,editedImageData:c,maskImageData:w}=g(P,a,T);$.putImageData(c,0,0);const I=f.toDataURL("image/png"),_=w?v(w):null;return{maskingMode:!!M,penImage:I,penMask:_}})().catch(k=>{throw s.delete(o),k});return s.set(o,D),D}return{getPenImages:y,clearPenMaskCache:i,clearRoomCache:m}}const Y=["src"],J={class:"glow-wrapper blur20"},Q={class:"glow-wrapper blur3"},Z={__name:"PenLight",props:{roomDetails:{type:Object,required:!0},color:{type:String,required:!0},opacity:{type:Number,default:1},penTransform:{type:Object,required:!0},penSize:{type:Number,default:256,required:!1},nickName:{type:String,default:"anonymous",required:!1},smoothMotion:{type:Boolean,default:!1,required:!1}},setup(s){const i=s,m=F(!1),{getPenImages:d}=W(),p=N(()=>{const r=i.roomDetails?.penlightSprite;return r?`${r}`:"/img/default_light.png"}),h=N(()=>{const r=i.penSize,g=i.penTransform.x,v=i.penTransform.y,y=i.penTransform.theta;return{left:`${g}px`,top:`${v}px`,width:`${r}px`,height:`${r}px`,transform:`translate(-50%, -50%) rotate(${y}deg)`,opacity:i.opacity,"--beam-color":`#${i.color}`}}),l=G(null);return O(async()=>{const r=i.roomDetails.code;l.value=await d(r,p.value,255),m.value=l.value?.maskingMode||!1}),(r,g)=>(K(),H("div",{class:C(["pen",{"use-motion-smoothing":s.smoothMotion}]),style:R(h.value),role:"img"},[b("img",{class:"pen-img",src:m.value?l.value.penImage:p.value,alt:"",draggable:"false"},null,8,Y),b("div",J,[b("div",{class:C(["glow",{"mask-mode":m.value}]),style:R(m.value?{"-webkit-mask-image":`url(${l.value.penMask})`,"mask-image":`url(${l.value.penMask})`}:{})},null,6)]),b("div",Q,[b("div",{class:C(["glow",{"mask-mode":m.value}]),style:R(m.value?{"-webkit-mask-image":`url(${l.value.penMask})`,"mask-image":`url(${l.value.penMask})`}:{})},null,6)]),b("div",{class:"pen-name",style:R({transform:`translateX(-50%) rotate(${-s.penTransform.theta}deg)`})},X(s.nickName),5)],6))}},te=U(Z,[["__scopeId","data-v-8ccd26d5"]]),z=new Map;async function ae(s=!1,i={}){const d=V().params.room_code,p=Array.isArray(d)?d[0]:typeof d=="string"?d:void 0;if(!p)return null;const{signal:h,timeoutMs:l=8e3}=i,r=p;if(s&&z.has(r))return z.get(r);const g=new AbortController,v=setTimeout(()=>g.abort(),l);h&&(h.aborted?g.abort():h.addEventListener("abort",()=>g.abort(),{once:!0}));const y=(async()=>{try{const e=await fetch(`https://api.pen.lighting/rooms/${encodeURIComponent(p)}`,{headers:{Accept:"application/json"},signal:g.signal});return e.ok?await e.json():null}catch{return null}finally{clearTimeout(v)}})();s&&z.set(r,y);const t=await y;return t===null&&s&&z.delete(r),t}export{te as P,ae as u};
