import{s as d,r as h,k as v,o as y,a as _,c as n,b as a,f as i,F as r,d as u,m as c,x as S,u as w}from"./index-DSsJm8DN.js";import{u as R}from"./useRoomDetails-DmG4IGp2.js";class g{constructor(e,t){this.roomCode=e,this.wsUrl=t??this._deriveWSUrl(),this._users=[],this.usersListRef=d([]),this.connectionStatusRef=h("idle"),this._socket=null,this._closedManually=!1,this.connect()}_deriveWSUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//api.${window.location.host}`}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const e=new WebSocket(this.wsUrl);this._socket=e,e.addEventListener("open",()=>{this.connectionStatusRef.value="open",e.send(JSON.stringify({type:"hello",role:"obs",roomCode:this.roomCode}))}),e.addEventListener("message",t=>{let s;try{s=JSON.parse(t.data)}catch{return}s?.type==="state"&&s?.room===this.roomCode&&Array.isArray(s.users)&&(this._users=s.users,this.usersListRef.value=[...this._users],console.log("Users update",this._users))}),e.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),e.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{e.close()}catch{}})}destroy(){if(this._closedManually=!0,this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this._users=[],this.usersListRef.value=[],this.connectionStatusRef.value="closed"}}const k="wss://api.pen.lighting/ws",O={__name:"ObsView",setup(f){const e=d(null),t=v();w();const s=t.params.room_code,l=h(null);return y(async()=>{e.value=new g(s,k),console.log("New OBSRoomState:",e.value),l.value=await R()}),_(()=>{e.value&&(e.value.destroy(),e.value=null)}),(L,o)=>e.value==null?(a(),n(r,{key:0},[i(" Connecting... ")],64)):(a(),n(r,{key:1},[o[0]||(o[0]=i(" Connected! ",-1)),u("pre",null,c(JSON.stringify(l.value,null,2)),1),o[1]||(o[1]=u("br",null,null,-1)),(a(!0),n(r,null,S(e.value.usersListRef.value,(m,p)=>(a(),n("pre",{key:p},c(JSON.stringify(m,null,2)),1))),128))],64))}};export{O as default};
