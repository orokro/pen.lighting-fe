import{_ as se,r as l,p as g,o as z,a as B,c as S,b as p,l as ne,d as r,A as u,F as E,x as ae,y as A,m as le,w as re,k as ie,s as O,z as ue,f as ce,u as me}from"./index-RybedRza.js";import{u as he}from"./useRoomDetails-D3wD6UGB.js";import{u as fe}from"./useRoomSession-k9OBCSQl.js";const de=["value","selected"],pe={class:"checkbox"},ve=["checked"],Re=["src"],X=256,ge={__name:"PenRoom",props:{roomDetails:{type:Object,required:!0},userRoomState:{type:Object,required:!0}},setup(y){const o=y,a=l(null),f=l(1),d=l(1);function c(){const e=a.value;if(!e)return;const t=e.getBoundingClientRect();f.value=Math.max(1,t.width),d.value=Math.max(1,t.height)}const i=g(()=>{const e=o.roomDetails&&o.roomDetails.penlightSprite;return e?`data:image/png;base64,${e}`:"/img/default_light.png"}),k=g(()=>w.value?o.roomDetails.penColors[o.userRoomState?.colorRef?.value]:F(o.roomDetails?.themeColor)||"FFFFFF"),w=g(()=>{const e=o.roomDetails?.penColors;return Array.isArray(e)&&e.length>0});function F(e){return e==null||e===""?null:(typeof e=="number"&&(e=(e>>>0).toString(16)),typeof e=="string"&&(e=e.trim(),e.startsWith("#")&&(e=e.slice(1)),e=e.toUpperCase(),e.length===3&&(e=e.split("").map(t=>t+t).join("")),e.length===6)?e:null)}function Y(e){return k.value===F(e)}function q(e){const t=String(e.target.value||"").replace(/^#/,"");o.userRoomState.colorRef.value=t}const I=g(()=>{const e=Number(o.userRoomState.xRef.value??.5),t=Number(o.userRoomState.yRef.value??.5),s=Number(o.userRoomState.thetaRef.value??0),n=e*f.value,h=t*d.value,R=n-X/2,$=h-X/2;return{transform:`translate(${R}px, ${$}px) rotate(${s}deg)`,"--beam-color":`#${k.value}`}}),V=g(()=>{const e=`url("${i.value}")`;return{background:`#${k.value}`,maskImage:e,maskRepeat:"no-repeat",maskSize:"256 256",maskPosition:"top left",WebkitMaskImage:e,WebkitMaskRepeat:"no-repeat",WebkitMaskSize:"256 256",WebkitMaskPosition:"top left",opacity:.7}});function m(e,t,s){return Math.max(t,Math.min(s,e))}function L(e,t,s){return e+(t-e)*s}const x=l(.5),C=l(.5),M=l(0);let _=0,T=null,U=0;function b(e){const t=e/1e3;_===0&&(_=t);const s=Math.max(.001,t-_),n=m(x.value+M.value,0,1),h=T==null?0:(n-T)/s,R=(h-U)/s;let Z=m(R*18,-90,90);const ee=Number(o.userRoomState.thetaRef.value||0),te=m(s*6,0,.65),oe=L(ee,Z,te);o.userRoomState.thetaRef.value=oe,o.userRoomState.xRef.value=n,o.userRoomState.yRef.value=m(C.value,0,1),_=t,T=n,U=h}function N(e,t){const n=a.value.getBoundingClientRect(),h=m((e-n.left)/n.width,0,1),R=m((t-n.top)/n.height,0,1);x.value=h,C.value=R,b(performance.now())}function j(e){N(e.clientX,e.clientY)}function H(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&N(t.clientX,t.clientY)}function J(e){e.cancelable&&e.preventDefault();const t=e.touches&&e.touches[0];t&&N(t.clientX,t.clientY)}function K(){}const W=l(!1);let v=null,P=0;function G(e){!!e.target.checked?Q():D()}function Q(){D(),W.value=!0,P=performance.now();const e=140/60,t=.1,s=n=>{const h=(n-P)/1e3;M.value=t*Math.sin(2*Math.PI*e*h),b(n),v=requestAnimationFrame(s)};v=requestAnimationFrame(s)}function D(){v!=null&&(cancelAnimationFrame(v),v=null),M.value=0,W.value=!1,b(performance.now())}return z(()=>{c();const e=new ResizeObserver(c);e.observe(a.value),a.value.__ro=e,Number.isFinite(o.userRoomState.xRef.value)||(o.userRoomState.xRef.value=.5),Number.isFinite(o.userRoomState.yRef.value)||(o.userRoomState.yRef.value=.5),Number.isFinite(o.userRoomState.thetaRef.value)||(o.userRoomState.thetaRef.value=0),x.value=m(Number(o.userRoomState.xRef.value),0,1),C.value=m(Number(o.userRoomState.yRef.value),0,1),b(performance.now())}),B(()=>{D();const e=a.value;e&&e.__ro&&(e.__ro.disconnect(),delete e.__ro)}),(e,t)=>(p(),S("div",{ref_key:"stageRef",ref:a,class:"room-stage",onMousemove:j,onTouchstart:H,onTouchmove:J,onTouchend:K,onContextmenu:t[8]||(t[8]=u(()=>{},["prevent"]))},[w.value?(p(),S("div",{key:0,class:"ui ui-left",onTouchstart:t[0]||(t[0]=u(()=>{},["stop"])),onTouchmove:t[1]||(t[1]=u(()=>{},["stop"])),onTouchend:t[2]||(t[2]=u(()=>{},["stop"])),onClick:t[3]||(t[3]=u(()=>{},["stop"]))},[t[9]||(t[9]=r("label",{class:"sr-only",for:"colorSelect"},"Penlight Color",-1)),r("select",{id:"colorSelect",class:"color-select",onChange:q},[(p(!0),S(E,null,ae(y.roomDetails.penColors,(s,n)=>(p(),S("option",{key:s,value:n,selected:Y(s)},le("#"+s.toUpperCase()),9,de))),128))],32)],32)):ne("",!0),r("div",{class:"ui ui-right",onTouchstart:t[4]||(t[4]=u(()=>{},["stop"])),onTouchmove:t[5]||(t[5]=u(()=>{},["stop"])),onTouchend:t[6]||(t[6]=u(()=>{},["stop"])),onClick:t[7]||(t[7]=u(()=>{},["stop"]))},[r("label",pe,[r("input",{type:"checkbox",checked:W.value,onChange:G},null,40,ve),t[10]||(t[10]=r("span",null,"Auto Wave",-1))])],32),t[11]||(t[11]=r("div",{class:"hint"},"drag your finger/mouse around!",-1)),r("div",{class:"light",style:A(I.value),role:"img","aria-label":"Penlight sprite"},[r("img",{class:"light__img",src:i.value,alt:"",draggable:"false"},null,8,Re),r("div",{class:"light__tint",style:A(V.value),"aria-hidden":"true"},null,4)],4)],544))}},Se=se(ge,[["__scopeId","data-v-12a1edd9"]]);class ye{constructor(o,a,f,d,c=0){this.roomCode=o,this.nickname=a||"guest",this.password=f,this.wsUrl=d??this._deriveWSUrl(),this.xRef=l(-100),this.yRef=l(-100),this.thetaRef=l(0),this.colorRef=l(0),this.connectionStatusRef=l("idle"),this._socket=null,this._closedManually=!1,this._sendTimer=null,this._debounceMs=Math.max(0,c|5),this.connect(),this._wireWatches()}_deriveWSUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//api.${window.location.host}`}connect(){this._closedManually=!1,this.connectionStatusRef.value="connecting";const o=new WebSocket(this.wsUrl);this._socket=o,o.addEventListener("open",()=>{this.connectionStatusRef.value="open";const a={type:"hello",role:"user",roomCode:this.roomCode,nickname:this.nickname};this.password!==void 0&&(a.password=this.password),o.send(JSON.stringify(a)),this._scheduleSend()}),o.addEventListener("close",()=>{this.connectionStatusRef.value="closed",this._closedManually||setTimeout(()=>this.connect(),1e3)}),o.addEventListener("error",()=>{this.connectionStatusRef.value="error";try{o.close()}catch{}})}_wireWatches(){[this.xRef,this.yRef,this.thetaRef,this.colorRef].forEach(o=>{re(o,()=>this._scheduleSend(),{flush:"post"})})}_scheduleSend(){!this._socket||this._socket.readyState!==WebSocket.OPEN||this._sendTimer||(this._sendTimer=setTimeout(()=>{this._sendTimer=null,this._sendUpdate()},this._debounceMs))}_sendUpdate(){if(!this._socket||this._socket.readyState!==WebSocket.OPEN)return;const o={type:"update",x:Number(this.xRef.value),y:Number(this.yRef.value),theta:Number(this.thetaRef.value),color:Number(this.colorRef.value)};try{this._socket.send(JSON.stringify(o))}catch{}}destroy(){if(this._closedManually=!0,this._sendTimer&&(clearTimeout(this._sendTimer),this._sendTimer=null),this._socket&&this._socket.readyState<=1)try{this._socket.close(1e3,"Client navigating away")}catch{}this._socket=null,this.connectionStatusRef.value="closed"}}const ke="wss://api.pen.lighting/ws",xe={__name:"RoomView",props:{room_code:String},setup(y){const{getRoomSession:o}=fe(),a=ie();me();const f=a.params.room_code,d=O(o(f)),c=l(null),i=O(null);return z(async()=>{i.value=new ye(f,d.value.username,d.value.roomPwd,ke),c.value=await he()}),B(()=>{i.value&&(i.value.destroy(),i.value=null)}),(k,w)=>i.value==null||c.value==null?(p(),S(E,{key:0},[ce(" Connecting... ")],64)):(p(),ue(Se,{key:1,roomDetails:c.value,userRoomState:i.value},null,8,["roomDetails","userRoomState"]))}};export{xe as default};
