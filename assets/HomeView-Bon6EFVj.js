import{_ as K,r as a,o as T,u as Q,s as X,w as Y,n as P,a as Z,c as oo,b as eo,d as s,e as _,f as to,v as S,g as j,h as no}from"./index-If-UVuQK.js";import{u as so}from"./useRoomSession-k9OBCSQl.js";const ao={class:"home-view"},ro={class:"row-contents"},lo=["maxlength"],io={class:"row-contents"},uo={class:"row-contents"},co=["disabled"],po={__name:"HomeView",setup(fo){const r=a(""),i=a(""),u=a(""),w=a(!1),l=a(!1),y=a(!1),c=a(!1),d=a(null),h=a(!1),R=a(""),k=a(""),N=a(null),E=a(null),V=a(null),q=no(),{saveRoomSession:$}=so(),b=Q();T(()=>{b?.query?.room_code&&(console.log("room code",b.query.room_code),r.value=String(b.query.room_code||"").trim().slice(0,6)),U()});const J="https://api.pen.lighting",B="https://pen.lighting";let p=null,x=0,f=null,I=0;const C=X(!1);Y([l,u],()=>{const e=!!l.value&&String(u.value||"").trim().length>0;C.value=e,y.value=e},{immediate:!0});function U(){R.value="",k.value="",g(),m(),A(),H({keepNickValue:!0});const e=String(r.value||"").trim();e.length===6&&z(e)}function L(){if(k.value="",m(),v(),!c.value||!d.value)return;const e=String(r.value||"").trim(),o=String(i.value||"");e.length===6&&o.length===d.value&&D(e,o)}function O(){}function A(){w.value=!1,c.value=!1,d.value=null,i.value=""}function H({keepNickValue:e}){v()}function v(){l.value=!1,y.value=!1}function M(){P(()=>E.value?.focus?.())}function F(){P(()=>V.value?.focus?.())}async function z(e){g(),x++;const o=x;p=new AbortController;try{const t=await fetch(`${B}/rooms/${encodeURIComponent(e)}`,{method:"GET",signal:p.signal});if(o!==x)return;if(!t.ok)throw new Error(t.status===404?"Room not found":"Room lookup failed");const n=await t.json();c.value=!!n.isProtected,d.value=Number(n.pwLength)||null,c.value?(w.value=!0,M()):(w.value=!1,l.value=!0,F())}catch(t){if(t?.name==="AbortError")return;R.value=t?.message||"Room lookup failed",A(),v()}finally{g()}}function g(){if(p){try{p.abort()}catch{}p=null}}async function D(e,o){m(),I++;const t=I;f=new AbortController;try{const n=await fetch(`${J}/users/join/${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:o,nick:""}),signal:f.signal});if(t!==I)return;if(!n.ok)throw new Error(n.status===403?"Incorrect password":"Password check failed");if(!(await n.json())?.ok)throw new Error("Password check failed");l.value=!0,F()}catch(n){if(n?.name==="AbortError")return;k.value=n?.message||"Password check failed",v()}finally{m()}}function m(){if(f){try{f.abort()}catch{}f=null}}async function G(){if(!C.value||h.value)return;const e=String(r.value||"").trim(),o=String(i.value||""),t=String(u.value||"").trim();h.value=!0;try{const n=await fetch(`${J}/users/join/${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:o,nick:t})});if(!n.ok)throw new Error("Failed to join room");if(!(await n.json())?.ok)throw new Error("Failed to join room");$(e,o,t),await q.push({path:`/room/${e}`})}catch(n){c.value?(k.value=n?.message||"Failed to join",v()):R.value=n?.message||"Failed to join"}finally{h.value=!1}}return T(()=>{P(()=>N.value?.focus?.())}),Z(()=>{g(),m()}),(e,o)=>(eo(),oo("div",ao,[o[6]||(o[6]=s("div",{class:"text-row"},[to(" Join a room! "),s("span",{class:"material-icons arrow"},"redo")],-1)),_(s("input",{ref_key:"roomCodeInput",ref:N,"onUpdate:modelValue":o[0]||(o[0]=t=>r.value=t),type:"text",placeholder:"Room Code",class:"room-code-input big-input",maxlength:"6",onInput:U},null,544),[[S,r.value]]),s("div",{class:j(["password-row row",{expanded:w.value}])},[s("div",ro,[o[3]||(o[3]=s("div",{class:"text-row"}," Enter private room PW: ",-1)),_(s("input",{ref_key:"passwordInput",ref:E,"onUpdate:modelValue":o[1]||(o[1]=t=>i.value=t),type:"text",placeholder:"Password",class:"room-code-input big-input",maxlength:d.value||null,onInput:L},null,40,lo),[[S,i.value]])])],2),s("div",{class:j(["nick-row row",{expanded:l.value}])},[s("div",io,[o[4]||(o[4]=s("div",{class:"text-row"}," Pick a nick: ",-1)),_(s("input",{ref_key:"nickInput",ref:V,"onUpdate:modelValue":o[2]||(o[2]=t=>u.value=t),type:"text",placeholder:"Nickname",class:"room-code-input big-input",maxlength:"16",onInput:O},null,544),[[S,u.value]])])],2),s("div",{class:j(["join-row row",{expanded:y.value}])},[s("div",uo,[o[5]||(o[5]=s("div",{class:"text-row"}," Rock & roll! ",-1)),s("button",{class:"join-button big-button",disabled:!C.value||h.value,onClick:G}," ~~ Join Room ~~ ",8,co)])],2)]))}},wo=K(po,[["__scopeId","data-v-7ba7714c"]]);export{wo as default};
